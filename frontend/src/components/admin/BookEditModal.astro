<div
    id="book-edit-modal"
    class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4"
>
    <div
        class="bg-white rounded-2xl shadow-xl max-w-lg w-full transform transition-all scale-95 opacity-0"
        id="modal-content"
    >
        <div
            class="p-6 border-b border-gray-100 flex justify-between items-center"
        >
            <h3 class="text-xl font-bold text-gray-800">
                แก้ไขข้อมูล: <span id="modal-book-name" class="text-primary"
                ></span>
            </h3>
            <button id="close-modal" class="text-gray-400 hover:text-gray-600"
                >✕</button
            >
        </div>

        <form id="edit-form" class="p-6 space-y-4">
            <input type="hidden" id="edit-book-id" name="book" />

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1"
                    >ชื่อภาษาไทย</label
                >
                <input
                    type="text"
                    id="edit-th"
                    name="th"
                    class="w-full px-4 py-2 rounded-xl border border-gray-200 focus:ring-2 focus:ring-primary focus:border-primary outline-none transition-all"
                />
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1"
                    >ชื่อภาษาอาหรับ</label
                >
                <input
                    type="text"
                    id="edit-ar"
                    name="ar"
                    class="w-full px-4 py-2 rounded-xl border border-gray-200 focus:ring-2 focus:ring-primary focus:border-primary outline-none transition-all font-arabic"
                    dir="rtl"
                />
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1"
                    >คำอธิบาย</label
                >
                <textarea
                    id="edit-desc"
                    name="description"
                    rows="4"
                    class="w-full px-4 py-2 rounded-xl border border-gray-200 focus:ring-2 focus:ring-primary focus:border-primary outline-none transition-all text-sm"
                ></textarea>
            </div>

            <div class="pt-4 flex gap-3">
                <button
                    type="submit"
                    class="flex-1 px-4 py-2 bg-primary text-white rounded-xl hover:bg-primary-dark transition-colors font-medium shadow-lg shadow-primary/30"
                >
                    บันทึก
                </button>
                <button
                    type="button"
                    id="cancel-btn"
                    class="flex-1 px-4 py-2 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 transition-colors font-medium"
                >
                    ยกเลิก
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    import { API_BASE_URL } from "../../lib/api";

    const modal = document.getElementById("book-edit-modal");
    const content = document.getElementById("modal-content");
    const form = document.getElementById("edit-form") as HTMLFormElement;

    // Open Modal Function (exposed to window for easy access from parent)
    window.openBookEditModal = (book) => {
        if (!modal || !content) return;

        // Populate fields
        document.getElementById("modal-book-name")!.textContent = book.book;
        (document.getElementById("edit-book-id") as HTMLInputElement).value =
            book.book;
        (document.getElementById("edit-th") as HTMLInputElement).value =
            book.th || "";
        (document.getElementById("edit-ar") as HTMLInputElement).value =
            book.ar || "";
        (document.getElementById("edit-desc") as HTMLInputElement).value =
            book.description || "";

        modal.classList.remove("hidden");
        // Simple animation
        setTimeout(() => {
            content.classList.remove("scale-95", "opacity-0");
            content.classList.add("scale-100", "opacity-100");
        }, 10);
    };

    function closeModal() {
        if (!modal || !content) return;
        content.classList.remove("scale-100", "opacity-100");
        content.classList.add("scale-95", "opacity-0");
        setTimeout(() => modal.classList.add("hidden"), 200);
    }

    document
        .getElementById("close-modal")
        ?.addEventListener("click", closeModal);
    document
        .getElementById("cancel-btn")
        ?.addEventListener("click", closeModal);

    // Submit Handler
    form?.addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        const bookId = formData.get("book");
        const data = Object.fromEntries(formData.entries());

        try {
            // Using existing backend API
            const res = await fetch(`${API_BASE_URL}/api/book-info/${bookId}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data),
            });

            if (res.ok) {
                alert("บันทึกข้อมูลเรียบร้อย ✅");
                window.location.reload(); // Reload to see changes
            } else {
                alert("เกิดข้อผิดพลาดในการบันทึก ❌");
            }
        } catch (error) {
            console.error(error);
            alert("เชื่อมต่อ Server ไม่ได้");
        }
    });
</script>

<div
    id="category-modal"
    class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4"
>
    <div
        class="bg-white rounded-2xl shadow-xl max-w-lg w-full transform transition-all scale-95 opacity-0"
        id="category-modal-content"
    >
        <div
            class="p-6 border-b border-gray-100 flex justify-between items-center"
        >
            <h3 class="text-xl font-bold text-gray-800" id="cat-modal-title">
                จัดการหมวดหมู่
            </h3>
            <button
                id="close-cat-modal"
                class="text-gray-400 hover:text-gray-600">✕</button
            >
        </div>

        <form id="category-form" class="p-6 space-y-4">
            <input type="hidden" id="cat-id" name="id" />

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1"
                    >ชื่อหมวดหมู่</label
                >
                <input
                    type="text"
                    id="cat-name"
                    name="name"
                    required
                    class="w-full px-4 py-2 rounded-xl border border-gray-200 focus:ring-2 focus:ring-primary outline-none"
                    placeholder="เช่น ข่าวประชาสัมพันธ์"
                    oninput="generateSlug(this.value)"
                />
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1"
                    >Slug (URL)</label
                >
                <input
                    type="text"
                    id="cat-slug"
                    name="slug"
                    required
                    class="w-full px-4 py-2 rounded-xl border border-gray-200 bg-gray-50 text-gray-600 focus:ring-2 focus:ring-primary outline-none font-mono text-sm"
                    placeholder="news-update"
                />
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1"
                    >คำอธิบาย</label
                >
                <textarea
                    id="cat-desc"
                    name="description"
                    rows="3"
                    class="w-full px-4 py-2 rounded-xl border border-gray-200 focus:ring-2 focus:ring-primary outline-none"
                ></textarea>
            </div>

            <div class="pt-4 flex gap-3">
                <button
                    type="submit"
                    class="flex-1 px-4 py-2 bg-primary text-white rounded-xl hover:bg-primary-dark transition-colors font-medium shadow-lg shadow-primary/30"
                >
                    บันทึก
                </button>
                <button
                    type="button"
                    id="delete-cat-btn"
                    class="hidden px-4 py-2 bg-red-50 text-red-600 rounded-xl hover:bg-red-100 transition-colors font-medium border border-red-200"
                >
                    ลบ
                </button>
                <button
                    type="button"
                    id="cancel-cat-btn"
                    class="flex-1 px-4 py-2 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 transition-colors font-medium"
                >
                    ยกเลิก
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    import {
        createCategory,
        updateCategory,
        deleteCategory,
    } from "../../lib/api";

    const modal = document.getElementById("category-modal");
    const content = document.getElementById("category-modal-content");
    const form = document.getElementById("category-form") as HTMLFormElement;
    const deleteBtn = document.getElementById("delete-cat-btn");

    // Slug Generator
    window.generateSlug = (value) => {
        const slugInput = document.getElementById(
            "cat-slug",
        ) as HTMLInputElement;
        if (
            !slugInput.value ||
            slugInput.getAttribute("data-modified") !== "true"
        ) {
            slugInput.value = value
                .toLowerCase()
                .replace(/ /g, "-")
                .replace(/[^\w-]+/g, "");
        }
    };

    document
        .getElementById("cat-slug")
        ?.addEventListener("input", function (this: HTMLInputElement) {
            this.setAttribute("data-modified", "true");
        });

    window.openCategoryModal = (category = null) => {
        if (!modal || !content) return;

        form.reset();
        document.getElementById("cat-slug")?.removeAttribute("data-modified");

        if (category) {
            document.getElementById("cat-modal-title")!.textContent =
                "แก้ไขหมวดหมู่";
            (document.getElementById("cat-id") as HTMLInputElement).value =
                category._id;
            (document.getElementById("cat-name") as HTMLInputElement).value =
                category.name;
            (document.getElementById("cat-slug") as HTMLInputElement).value =
                category.slug;
            (document.getElementById("cat-desc") as HTMLInputElement).value =
                category.description || "";

            deleteBtn?.classList.remove("hidden");
            deleteBtn!.onclick = () => confirmDelete(category._id);
        } else {
            document.getElementById("cat-modal-title")!.textContent =
                "เพิ่มหมวดหมู่ใหม่";
            (document.getElementById("cat-id") as HTMLInputElement).value = "";
            deleteBtn?.classList.add("hidden");
        }

        modal.classList.remove("hidden");
        setTimeout(() => {
            content.classList.remove("scale-95", "opacity-0");
            content.classList.add("scale-100", "opacity-100");
        }, 10);
    };

    function closeModal() {
        if (!modal || !content) return;
        content.classList.remove("scale-100", "opacity-100");
        content.classList.add("scale-95", "opacity-0");
        setTimeout(() => modal.classList.add("hidden"), 200);
    }

    [
        document.getElementById("close-cat-modal"),
        document.getElementById("cancel-cat-btn"),
    ].forEach((el) => el?.addEventListener("click", closeModal));

    form?.addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        const id = formData.get("id") as string;
        const data = {
            name: formData.get("name") as string,
            slug: formData.get("slug") as string,
            description: formData.get("description") as string,
        };

        try {
            if (id) {
                await updateCategory(id, data);
                alert("บันทึกเรียบร้อย ✅");
            } else {
                await createCategory(data);
                alert("สร้างหมวดหมู่เรียบร้อย ✅");
            }
            window.location.reload();
        } catch (error) {
            console.error(error);
            alert("เกิดข้อผิดพลาด");
        }
    });

    async function confirmDelete(id) {
        if (!confirm("ยืนยันที่จะลบ? บทความในหมวดนี้อาจได้รับผลกระทบ")) return;
        try {
            await deleteCategory(id);
            window.location.reload();
        } catch (e) {
            console.error(e);
            alert("ลบไม่สำเร็จ");
        }
    }
</script>

<div
    id="kitab-modal"
    class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4"
>
    <div
        class="bg-white rounded-2xl shadow-xl max-w-lg w-full transform transition-all scale-95 opacity-0"
        id="kitab-modal-content"
    >
        <div
            class="p-6 border-b border-gray-100 flex justify-between items-center"
        >
            <h3 class="text-xl font-bold text-gray-800" id="modal-title">
                ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏ß‡∏î (Kitab)
            </h3>
            <button
                id="close-kitab-modal"
                class="text-gray-400 hover:text-gray-600">‚úï</button
            >
        </div>

        <form id="kitab-form" class="p-6 space-y-4">
            <input type="hidden" id="kitab-book-slug" name="book" />
            <input type="hidden" id="kitab-uuid" name="kitab_id" />
            <!-- If present, update. If empty, create -->

            <div class="grid grid-cols-4 gap-4">
                <div class="col-span-1">
                    <label class="block text-sm font-medium text-gray-700 mb-1"
                        >‡∏•‡∏≥‡∏î‡∏±‡∏ö (Order)</label
                    >
                    <input
                        type="number"
                        id="kitab-order"
                        name="order"
                        required
                        class="w-full px-4 py-2 rounded-xl border border-gray-200 focus:ring-2 focus:ring-primary focus:border-primary outline-none transition-all"
                    />
                </div>
                <div class="col-span-3">
                    <label class="block text-sm font-medium text-gray-700 mb-1"
                        >‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢</label
                    >
                    <input
                        type="text"
                        id="kitab-th"
                        name="th"
                        required
                        class="w-full px-4 py-2 rounded-xl border border-gray-200 focus:ring-2 focus:ring-primary focus:border-primary outline-none transition-all"
                    />
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1"
                    >‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏≤‡∏´‡∏£‡∏±‡∏ö</label
                >
                <input
                    type="text"
                    id="kitab-ar"
                    name="ar"
                    required
                    class="w-full px-4 py-2 rounded-xl border border-gray-200 focus:ring-2 focus:ring-primary focus:border-primary outline-none transition-all font-arabic"
                    dir="rtl"
                />
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1"
                    >‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© (Optional)</label
                >
                <input
                    type="text"
                    id="kitab-en"
                    name="en"
                    class="w-full px-4 py-2 rounded-xl border border-gray-200 focus:ring-2 focus:ring-primary focus:border-primary outline-none transition-all"
                />
            </div>

            <div class="pt-4 flex gap-3">
                <button
                    type="submit"
                    class="flex-1 px-4 py-2 bg-primary text-white rounded-xl hover:bg-primary-dark transition-colors font-medium shadow-lg shadow-primary/30"
                >
                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                </button>
                <button
                    type="button"
                    id="delete-kitab-btn"
                    class="hidden px-4 py-2 bg-red-50 text-red-600 rounded-xl hover:bg-red-100 transition-colors font-medium border border-red-200"
                >
                    ‡∏•‡∏ö
                </button>
                <button
                    type="button"
                    id="cancel-kitab-btn"
                    class="flex-1 px-4 py-2 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 transition-colors font-medium"
                >
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    import {
        createKitab,
        updateKitab,
        deleteKitab,
        type KitabItem,
    } from "../../lib/api";

    const modal = document.getElementById("kitab-modal");
    const content = document.getElementById("kitab-modal-content");
    const form = document.getElementById("kitab-form") as HTMLFormElement;
    const deleteBtn = document.getElementById("delete-kitab-btn");

    // Open Modal
    window.openKitabModal = (bookSlug, kitab = null) => {
        if (!modal || !content) return;

        const isEdit = !!kitab;
        document.getElementById("modal-title")!.textContent = isEdit
            ? "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏°‡∏ß‡∏î (Edit Kitab)"
            : "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡πÉ‡∏´‡∏°‡πà (Add Kitab)";

        // Reset form
        form.reset();

        // Set values
        (document.getElementById("kitab-book-slug") as HTMLInputElement).value =
            bookSlug;

        if (isEdit) {
            (document.getElementById("kitab-uuid") as HTMLInputElement).value =
                kitab.kitab_id || "";
            (document.getElementById("kitab-order") as HTMLInputElement).value =
                kitab.id?.toString() || "";
            (document.getElementById("kitab-th") as HTMLInputElement).value =
                kitab.th || "";
            (document.getElementById("kitab-ar") as HTMLInputElement).value =
                kitab.ar || "";
            (document.getElementById("kitab-en") as HTMLInputElement).value =
                kitab.en || "";

            if (deleteBtn) {
                deleteBtn.classList.remove("hidden");
                deleteBtn.onclick = () => confirmDelete(kitab.kitab_id);
            }
        } else {
            (document.getElementById("kitab-uuid") as HTMLInputElement).value =
                ""; // Empty for create
            if (deleteBtn) deleteBtn.classList.add("hidden");
        }

        modal.classList.remove("hidden");
        setTimeout(() => {
            content.classList.remove("scale-95", "opacity-0");
            content.classList.add("scale-100", "opacity-100");
        }, 10);
    };

    function closeModal() {
        if (!modal || !content) return;
        content.classList.remove("scale-100", "opacity-100");
        content.classList.add("scale-95", "opacity-0");
        setTimeout(() => modal.classList.add("hidden"), 200);
    }

    [
        document.getElementById("close-kitab-modal"),
        document.getElementById("cancel-kitab-btn"),
    ].forEach((el) => el?.addEventListener("click", closeModal));

    // Submit Handler
    form?.addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        const kitabId = formData.get("kitab_id") as string;
        const book = formData.get("book") as string;

        const payload = {
            book: book,
            kitab_id: kitabId, // Needed for backend logic sometimes, or handled by route
            order: parseInt(formData.get("order") as string),
            name: {
                th: formData.get("th") as string,
                ar: formData.get("ar") as string,
                en: formData.get("en") as string,
            },
            // Legacy schema support if needed, but 'name' structure seems used in updateKitab route matches
            ar: formData.get("ar") as string,
            th: formData.get("th") as string,
            en: formData.get("en") as string,
            id: parseInt(formData.get("order") as string),
        };

        try {
            if (kitabId) {
                // Update
                await updateKitab(kitabId, payload as any);
                alert("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚úÖ");
            } else {
                // Create
                // Generate a random UUID locally if backend expects it, OR let backend handle it.
                // Looking at backend `fastify.post('/kitabs')`: it checks `if (!kitab.kitab_id) return 400`.
                // So WE MUST generate ID here.
                const newId = crypto.randomUUID();
                payload.kitab_id = newId;

                await createKitab(payload as any);
                alert("‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏°‡∏ß‡∏î‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚úÖ");
            }
            window.location.reload();
        } catch (error) {
            console.error(error);
            alert(
                "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " +
                    (error instanceof Error ? error.message : "Unknown error"),
            );
        }
    });

    async function confirmDelete(id: string) {
        if (!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ"))
            return;
        try {
            await deleteKitab(id);
            alert("‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ üóëÔ∏è");
            window.location.reload();
        } catch (error) {
            console.error(error);
            alert("‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        }
    }
</script>

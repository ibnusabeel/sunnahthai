---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getKitabs, getStats, getBookInfo, BOOK_NAMES, getDynamicBookNames } from "../../lib/api";

// Server mode - dynamic routing
const { book } = Astro.params as { book: string };

// Fetch dynamic names
let bookNames = { ...BOOK_NAMES };
try {
    const dynamicNames = await getDynamicBookNames();
    bookNames = { ...bookNames, ...dynamicNames };
} catch (e) { console.error(e); }

const bookInfo = bookNames[book] || { th: book, ar: "", icon: "üìö" };

// Book colors
const bookColors: Record<string, { bg: string; accent: string; border: string }> = {
  bukhari: { bg: "from-mint-soft to-mint-light", accent: "text-emerald-700", border: "border-mint" },
  muslim: { bg: "from-sky-soft to-sky-light", accent: "text-sky-700", border: "border-sky" },
  nasai: { bg: "from-peach-soft to-peach-light", accent: "text-orange-700", border: "border-peach" },
  tirmidhi: { bg: "from-pink-soft to-pink-light", accent: "text-pink-700", border: "border-pink" },
  abudawud: { bg: "from-primary-soft to-lavender-light", accent: "text-primary", border: "border-primary-light" },
  ibnmajah: { bg: "from-lavender-light to-primary-soft", accent: "text-violet-700", border: "border-lavender" },
};
const colors = bookColors[book] || { bg: "from-gray-100 to-white", accent: "text-gray-700", border: "border-gray-200" };

// Fetch data
let kitabs = { book, kitabs: [] as Array<{ ar: string; th: string; en?: string }> };
let stats = { book: null as string | null, overall: { total: 0, translated: 0, pending: 0, percentage: 0 } };
let metadata = { book, description: "" };

try {
  [kitabs, stats, metadata] = await Promise.all([
    getKitabs(book),
    getStats(book),
    getBookInfo(book),
  ]);
} catch (error) {
  console.error("Failed to fetch data:", error);
}
---

<BaseLayout title={`${bookInfo.th} | ‡∏ã‡∏∏‡∏ô‡∏ô‡∏∞‡∏´‡πå‡πÑ‡∏ó‡∏¢`}>
  <!-- Hero Section -->
  <section class={`relative py-16 bg-gradient-to-br ${colors.bg} ${colors.border} border-b-2 overflow-hidden`}>
    <!-- Decorative Elements -->
    <div class="absolute inset-0 overflow-hidden">
      <div class="absolute top-10 left-10 w-32 h-32 bg-white/30 rounded-full blur-2xl"></div>
      <div class="absolute bottom-10 right-10 w-40 h-40 bg-white/20 rounded-full blur-3xl"></div>
    </div>

    <div class="container mx-auto px-4 relative z-10">
      <div class="max-w-3xl mx-auto text-center">
        <!-- Book Icon -->
        <div class="inline-flex items-center justify-center w-20 h-20 bg-white/80 rounded-full shadow-lg mb-6">
          <span class="text-4xl">{bookInfo.icon}</span>
        </div>

        <!-- Title -->
        <h1 class="text-3xl md:text-4xl font-bold text-text mb-2">
          {bookInfo.th}
        </h1>
        <p class="text-xl font-arabic text-text-muted mb-6" dir="rtl">
          {bookInfo.ar}
        </p>

        <!-- Stats -->
        <div class="flex flex-wrap justify-center gap-4 text-sm">
          <div class="bg-white/70 backdrop-blur px-4 py-2 rounded-full shadow-sm">
            üìö <span class="font-bold">{stats.overall.total.toLocaleString()}</span> ‡∏´‡∏∞‡∏î‡∏µ‡∏©
          </div>
          <div class="bg-white/70 backdrop-blur px-4 py-2 rounded-full shadow-sm">
            ‚úÖ <span class="font-bold">{stats.overall.translated.toLocaleString()}</span> ‡πÅ‡∏õ‡∏•‡πÅ‡∏•‡πâ‡∏ß
          </div>
          <div class="bg-white/70 backdrop-blur px-4 py-2 rounded-full shadow-sm">
            üìä <span class="font-bold text-primary">{stats.overall.percentage}%</span>
          </div>
        </div>

        <!-- Description (if exists) -->
        {metadata.description && (
          <div class="mt-8 max-w-2xl mx-auto text-left relative">
             <div class="bg-white/60 backdrop-blur rounded-2xl p-6 shadow-sm border border-white/50">
                <h3 class="font-bold text-gray-800 mb-2 flex items-center gap-2">
                  ‚ÑπÔ∏è ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠
                </h3>
                <div id="desc-container" class="relative overflow-hidden transition-all duration-500 max-h-[100px]">
                  <p class="text-gray-600 leading-relaxed whitespace-pre-line text-sm">
                    {metadata.description}
                  </p>
                  <div id="desc-fade" class="absolute bottom-0 left-0 w-full h-12 bg-gradient-to-t from-white/90 to-transparent"></div>
                </div>
                <button id="btn-readmore" class="mt-2 text-primary text-sm font-medium hover:underline flex items-center gap-1">
                  <span>‡∏≠‡πà‡∏≤‡∏ô‡∏ï‡πà‡∏≠</span>
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
             </div>
          </div>
        )}

        <!-- Action Links -->
        <div class="flex flex-wrap justify-center gap-3 mt-6">
          <a href={`/${book}?view=all`} class="btn btn-primary">
            üìñ ‡∏î‡∏π‡∏´‡∏∞‡∏î‡∏µ‡∏©‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
          </a>
          <a href="/" class="btn btn-secondary">
            ‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- Kitab List -->
  <section class="container mx-auto px-4 py-8">
    <div class="max-w-4xl mx-auto">
      <h2 class="text-xl font-bold text-text mb-6 flex items-center gap-2">
        üìÅ ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà (‡∏Å‡∏¥‡∏ï‡∏≤‡∏ö)
        <span class="text-sm font-normal text-text-muted">
          {kitabs.kitabs.length} ‡∏´‡∏°‡∏ß‡∏î
        </span>
      </h2>

      {kitabs.kitabs.length > 0 ? (
        <div class="space-y-2">
          {kitabs.kitabs.map((kitab, index) => {
            const displayName = kitab.th || kitab.en || kitab.ar;
            const filterValue = encodeURIComponent(kitab.th || kitab.en || kitab.ar);
            
            const targetUrl = (kitabs.kitabs.length === 1) ? `/${book}?view=all` : `/${book}?kitab=${filterValue}`;
            
            return (
              <a
                href={targetUrl}
                class={`block group p-4 bg-white rounded-xl border-2 ${colors.border} hover:shadow-md hover:border-primary transition-all duration-200`}
              >
                <div class="flex items-center gap-4">
                  <!-- Number Badge -->
                  <div class={`w-10 h-10 flex-shrink-0 rounded-full bg-gradient-to-br ${colors.bg} flex items-center justify-center font-bold ${colors.accent} shadow-sm group-hover:scale-110 transition-transform`}>
                    {index + 1}
                  </div>
                  
                  <!-- Text Content -->
                  <div class="flex-1 min-w-0">
                    {/* Thai or English Name */}
                    <div class="font-medium text-text md:float-left group-hover:text-primary transition-colors">
                      {kitab.th || kitab.en || displayName}
                    </div>
                    
                    {/* Arabic Name - Only show if different from display */}
                    {kitab.ar && (kitab.th || kitab.en) && (
                      <div class="text-xl font-arabic md:float-right text-text-muted mt-1" dir="rtl">
                        {kitab.ar}
                      </div>
                    )}
                    
                
                  </div>

                  <!-- Arrow -->
                  <div class="text-text-light group-hover:text-primary group-hover:translate-x-1 transition-all">
                    ‚Üí
                  </div>
                </div>
              </a>
            );
          })}
        </div>
      ) : (
        <div class="text-center py-16 bg-surface rounded-xl">
          <div class="text-4xl mb-4">üìÇ</div>
          <p class="text-text-muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</p>
        </div>
      )}
    </div>
  </section>

  <script>
    const container = document.getElementById('desc-container');
    const btn = document.getElementById('btn-readmore');
    const fade = document.getElementById('desc-fade');
    let isExpanded = false;

    if (container && btn && fade) {
      // Check if content is short enough to not need read more
      if (container.scrollHeight <= 100) {
        btn.style.display = 'none';
        fade.style.display = 'none';
        container.classList.remove('max-h-[100px]');
      } else {
        btn.addEventListener('click', () => {
          isExpanded = !isExpanded;
          if (isExpanded) {
            container.style.maxHeight = container.scrollHeight + 'px';
            fade.style.opacity = '0';
            btn.innerHTML = `<span>‡∏¢‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö</span><svg class="w-4 h-4 rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>`;
          } else {
            container.style.maxHeight = '100px';
            fade.style.opacity = '1';
            btn.innerHTML = `<span>‡∏≠‡πà‡∏≤‡∏ô‡∏ï‡πà‡∏≠</span><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>`;
          }
        });
      }
    }
  </script>
</BaseLayout>

---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getKitabs, getStats, getBookInfo, BOOK_NAMES, getDynamicBookNames } from "../../lib/api";

const { book } = Astro.params as { book: string };

// Fetch dynamic names
let bookNames = { ...BOOK_NAMES };
try {
    const dynamicNames = await getDynamicBookNames();
    bookNames = { ...bookNames, ...dynamicNames };
} catch (e) { console.error(e); }

const bookInfo = bookNames[book] || { th: book, ar: "", icon: "üìö" };

// Book colors - matching homepage pastel styles
const bookColors: Record<string, { bg: string; accent: string; border: string; badge: string }> = {
  bukhari: { bg: "from-mint-soft to-mint-light", accent: "text-emerald-700", border: "border-mint", badge: "bg-mint" },
  muslim: { bg: "from-sky-soft to-sky-light", accent: "text-sky-700", border: "border-sky", badge: "bg-sky-400" },
  nasai: { bg: "from-peach-soft to-peach-light", accent: "text-orange-700", border: "border-peach", badge: "bg-peach" },
  tirmidhi: { bg: "from-pink-soft to-pink-light", accent: "text-pink-700", border: "border-pink", badge: "bg-pink" },
  abudawud: { bg: "from-primary-soft to-lavender-light", accent: "text-primary", border: "border-primary-light", badge: "bg-primary" },
  ibnmajah: { bg: "from-lavender-light to-primary-soft", accent: "text-violet-700", border: "border-lavender", badge: "bg-lavender" },
  riyad: { bg: "from-mint-soft to-sky-soft", accent: "text-teal-700", border: "border-mint", badge: "bg-teal-500" },
  lulu: { bg: "from-amber-100 to-amber-50", accent: "text-amber-700", border: "border-amber-300", badge: "bg-amber-400" },
  adab: { bg: "from-lime-100 to-green-50", accent: "text-lime-700", border: "border-lime-300", badge: "bg-lime-500" },
};
const colors = bookColors[book] || { bg: "from-gray-100 to-white", accent: "text-gray-700", border: "border-gray-200", badge: "bg-gray-500" };

// Fetch data
let kitabs = { book, kitabs: [] as Array<{ kitab_id?: string; ar: string; th: string; en?: string; id?: number; min_hadith?: number | string; max_hadith?: number | string; hadith_count?: number }> };
let stats = { book: null as string | null, overall: { total: 0, translated: 0, pending: 0, percentage: 0 } };
let metadata = { book, description: "" };

try {
  [kitabs, stats, metadata] = await Promise.all([
    getKitabs(book),
    getStats(book),
    getBookInfo(book),
  ]);
} catch (error) {
  console.error("Failed to fetch data:", error);
}
---

<BaseLayout title={`${bookInfo.th} | ‡∏ã‡∏∏‡∏ô‡∏ô‡∏∞‡∏´‡πå‡πÑ‡∏ó‡∏¢`}>
  <!-- Hero Section with Pastel Gradient -->
  <section class={`relative py-16 md:py-20 bg-gradient-to-br ${colors.bg} ${colors.border} border-b-2 overflow-hidden`}>
    <!-- Decorative blobs - matching homepage style -->
    <div class="absolute top-10 right-10 w-72 h-72 bg-pink-light/30 blob blur-3xl"></div>
    <div class="absolute top-20 left-10 w-64 h-64 bg-primary-light/20 blob blur-3xl"></div>
    <div class="absolute bottom-10 right-1/4 w-48 h-48 bg-mint-light/30 blob blur-3xl"></div>

    <div class="container mx-auto px-4 relative z-10">
      <div class="max-w-3xl mx-auto text-center animate-fade-in">
        <!-- Icon Badge -->
        <div class="inline-flex items-center justify-center w-20 h-20 bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg mb-6 transform hover:scale-110 transition-transform duration-300">
          <span class="text-4xl">{bookInfo.icon}</span>
        </div>

        <!-- Thai Title -->
        <h1 class="text-3xl md:text-4xl lg:text-5xl font-bold text-text mb-2">
          {bookInfo.th}
        </h1>

        <!-- Arabic Title -->
        <p class="text-xl md:text-2xl font-arabic text-text-muted mb-8" dir="rtl">
          {bookInfo.ar}
        </p>

        <!-- Stats Pills -->
        <div class="flex flex-wrap justify-center gap-3 mb-8">
          <div class="bg-white/70 backdrop-blur-sm px-5 py-2.5 rounded-full shadow-sm flex items-center gap-2">
            <span>üìö</span>
            <span class="font-bold">{stats.overall.total.toLocaleString()}</span>
            <span class="text-text-muted text-sm">‡∏´‡∏∞‡∏î‡∏µ‡∏©</span>
          </div>
          <div class="bg-white/70 backdrop-blur-sm px-5 py-2.5 rounded-full shadow-sm flex items-center gap-2">
            <span>‚úÖ</span>
            <span class="font-bold">{stats.overall.translated.toLocaleString()}</span>
            <span class="text-text-muted text-sm">‡πÅ‡∏õ‡∏•‡πÅ‡∏•‡πâ‡∏ß</span>
          </div>
          <div class="bg-white/70 backdrop-blur-sm px-5 py-2.5 rounded-full shadow-sm flex items-center gap-2">
            <span>üìä</span>
            <span class="font-bold text-primary">{stats.overall.percentage}%</span>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="flex flex-wrap justify-center gap-3">
          <a href={`/${book}?view=all`} class="btn btn-primary">
            üìñ ‡∏î‡∏π‡∏´‡∏∞‡∏î‡∏µ‡∏©‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
          </a>
          <a href="/" class="btn btn-secondary">
            ‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- Search Section -->
  <section class="sticky top-0 z-30 bg-white/90 backdrop-blur-lg border-b border-gray-100 shadow-sm">
    <div class="container mx-auto px-4 py-4">
      <div class="max-w-2xl mx-auto">
        <div class="relative">
          <input
            type="text"
            id="kitab-search"
            placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà... (‡πÑ‡∏ó‡∏¢/‡∏≠‡∏≤‡∏´‡∏£‡∏±‡∏ö)"
            class="w-full px-5 py-3.5 pl-12 bg-gray-50 border-2 border-gray-200 rounded-2xl text-text placeholder-text-light focus:outline-none focus:border-primary focus:ring-4 focus:ring-primary/10 transition-all duration-200"
          />
          <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-text-light" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
          <span id="search-count" class="absolute right-4 top-1/2 -translate-y-1/2 text-sm text-text-muted hidden"></span>
        </div>
      </div>
    </div>
  </section>

  <!-- Kitab List Section -->
  <section class="container mx-auto px-4 py-10">
    <div class="max-w-4xl mx-auto">
      <!-- Section Header -->
      <div class="flex items-center justify-between mb-8">
        <h2 class="text-xl md:text-2xl font-bold text-text flex items-center gap-3">
          <span class={`w-10 h-10 rounded-xl ${colors.badge} flex items-center justify-center text-white`}>üìÅ</span>
          ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        </h2>
        <span id="kitab-counter" class="text-sm text-text-muted bg-surface px-4 py-2 rounded-full">
          {kitabs.kitabs.length} ‡∏´‡∏°‡∏ß‡∏î
        </span>
      </div>

      {kitabs.kitabs.length > 0 ? (
        <div id="kitab-list" class="space-y-3">
          {kitabs.kitabs.map((kitab, index) => {
            const displayTh = kitab.th || kitab.en || '';
            const displayAr = kitab.ar || '';
            const filterValue = encodeURIComponent(kitab.th || kitab.en || kitab.ar);
            const targetUrl = (kitabs.kitabs.length === 1) ? `/${book}?view=all` : `/${book}?kitab=${filterValue}`;
            
            return (
              <a
                href={targetUrl}
                class={`kitab-card group block bg-white rounded-2xl border-2 ${colors.border} hover:shadow-lg hover:border-primary transition-all duration-300 overflow-hidden`}
                data-th={displayTh.toLowerCase()}
                data-ar={displayAr}
              >
                <div class="flex items-stretch">
                  <!-- Number Badge -->
                  <div class={`flex-shrink-0 w-16 md:w-20 bg-gradient-to-br ${colors.bg} flex items-center justify-center`}>
                    <span class={`text-xl md:text-2xl font-bold ${colors.accent}`}>{index + 1}</span>
                  </div>
                  
                  <!-- Content -->
                  <div class="flex-1 p-4 md:p-5 min-w-0">
                    <!-- Thai Name -->
                    <div class="flex items-start gap-2 mb-2">
                      
                      <h3 class={`text-base md:text-lg font-semibold text-text group-hover:text-primary transition-colors leading-snug`}>
                        {displayTh || <span class="text-text-light italic">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ó‡∏¢</span>}
                      </h3>
                    </div>
                    
                    <!-- Arabic Name -->
                    {displayAr && (
                      <div class="flex items-start gap-2">
                        
                        <p class="text-base md:text-lg font-arabic text-text-muted leading-relaxed" dir="rtl">
                          {displayAr}
                        </p>
                      </div>
                    )}

                    <!-- Hadith Range 
                    {(kitab.min_hadith || kitab.max_hadith) && (
                      <div class="mt-2 text-sm text-text-muted flex items-center gap-1">
                        <span class="text-primary">üìú</span>
                        <span>‡∏´‡∏∞‡∏î‡∏µ‡∏© {kitab.min_hadith}{kitab.max_hadith && kitab.min_hadith !== kitab.max_hadith ? `-${kitab.max_hadith}` : ''}</span>
                        {kitab.hadith_count && <span class="text-text-light">({kitab.hadith_count} ‡∏´‡∏∞‡∏î‡∏µ‡∏©)</span>}
                      </div>
                    )} -->
                  </div>

                  <!-- Arrow -->
                  <div class="flex-shrink-0 flex items-center px-4 md:px-5 text-text-light group-hover:text-primary group-hover:translate-x-1 transition-all duration-300">
                    <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                  </div>
                </div>
              </a>
            );
          })}
        </div>
      ) : (
        <div class="text-center py-16 bg-surface rounded-3xl">
          <div class="text-5xl mb-4">üìÇ</div>
          <p class="text-lg text-text-muted mb-2">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</p>
          <p class="text-text-light">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ô‡∏µ‡πâ</p>
        </div>
      )}

      <!-- No Results Message -->
      <div id="no-results" class="hidden text-center py-16 bg-surface rounded-3xl mt-4">
        <div class="text-5xl mb-4">üîç</div>
        <p class="text-lg text-text-muted mb-2">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</p>
        <p class="text-text-light">‡∏•‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏≠‡∏∑‡πà‡∏ô</p>
      </div>
    </div>
  </section>

  <!-- Description Section (if exists) -->
  {metadata.description && (
    <section class="container mx-auto px-4 pb-12">
      <div class="max-w-4xl mx-auto">
        <div class={`bg-gradient-to-br ${colors.bg} rounded-3xl p-6 md:p-8 border-2 ${colors.border}`}>
          <h3 class="font-bold text-text mb-4 flex items-center gap-3 text-lg">
            <span class={`w-10 h-10 rounded-xl ${colors.badge} flex items-center justify-center text-white`}>‚ÑπÔ∏è</span>
            ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠
          </h3>
          <p class="text-text-muted leading-relaxed whitespace-pre-line">
            {metadata.description}
          </p>
        </div>
      </div>
    </section>
  )}

  <script>
    // Search functionality
    const searchInput = document.getElementById('kitab-search') as HTMLInputElement;
    const kitabList = document.getElementById('kitab-list');
    const kitabCounter = document.getElementById('kitab-counter');
    const searchCount = document.getElementById('search-count');
    const noResults = document.getElementById('no-results');
    const kitabCards = document.querySelectorAll('.kitab-card');
    const totalKitabs = kitabCards.length;

    if (searchInput && kitabList) {
      searchInput.addEventListener('input', (e) => {
        const query = (e.target as HTMLInputElement).value.toLowerCase().trim();
        let visibleCount = 0;

        kitabCards.forEach((card) => {
          const th = card.getAttribute('data-th') || '';
          const ar = card.getAttribute('data-ar') || '';
          const matches = th.includes(query) || ar.includes(query);
          
          if (matches) {
            (card as HTMLElement).style.display = 'block';
            visibleCount++;
          } else {
            (card as HTMLElement).style.display = 'none';
          }
        });

        // Update counter
        if (kitabCounter) {
          kitabCounter.textContent = query ? `${visibleCount}/${totalKitabs} ‡∏´‡∏°‡∏ß‡∏î` : `${totalKitabs} ‡∏´‡∏°‡∏ß‡∏î`;
        }

        // Show/hide no results message
        if (noResults) {
          noResults.classList.toggle('hidden', visibleCount > 0 || !query);
        }

        // Show search count badge
        if (searchCount && query) {
          searchCount.textContent = `${visibleCount} ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå`;
          searchCount.classList.remove('hidden');
        } else if (searchCount) {
          searchCount.classList.add('hidden');
        }
      });
    }
  </script>
</BaseLayout>

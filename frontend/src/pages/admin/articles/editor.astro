---
import AdminLayout from "../../../layouts/AdminLayout.astro";
import { getArticle, getCategories } from "../../../lib/api";

const id = Astro.url.searchParams.get("id");
let article: any = null;
let categories: any[] = [];

try {
    const res = await getCategories();
    categories = res.categories;

    if (id) {
        article = await getArticle(id);
    }
} catch (e) {
    console.error("Error loading editor data:", e);
}

const isEdit = !!article;
---

<AdminLayout title={isEdit ? "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°" : "‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà"}>
    <link
        href="https://cdn.quilljs.com/1.3.6/quill.snow.css"
        rel="stylesheet"
    />

    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-gray-800">
            {isEdit ? "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°" : "‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà"}
        </h1>
        <div class="flex gap-3">
            <a
                href="/admin/articles"
                class="px-4 py-2 bg-white text-gray-600 border border-gray-200 rounded-xl hover:bg-gray-50 transition-colors"
            >
                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
            </a>
            <button
                id="save-btn"
                class="px-6 py-2 bg-primary text-white rounded-xl hover:bg-primary-dark transition-colors font-bold shadow-lg shadow-primary/30 flex items-center gap-2"
            >
                <span>üíæ</span> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
            </button>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Main Editor -->
        <div class="lg:col-span-2 space-y-6">
            <div
                class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm"
            >
                <input
                    type="text"
                    id="title"
                    class="w-full text-3xl font-bold placeholder-gray-300 border-none outline-none focus:ring-0 p-0 text-gray-800"
                    placeholder="‡πÉ‡∏™‡πà‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."
                    value={article?.title || ""}
                    oninput="generateSlug(this.value)"
                />
                <div class="h-px bg-gray-100 my-4"></div>

                <!-- Toolbar for Quill -->
                <div id="editor-container" class="h-[500px] text-lg"></div>
                <input
                    type="hidden"
                    id="content"
                    value={article?.content || ""}
                />
            </div>
        </div>

        <!-- Sidebar Settings -->
        <div class="space-y-6">
            <!-- Publish Settings -->
            <div
                class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm space-y-4"
            >
                <h3 class="font-bold text-gray-800">‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</h3>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1"
                        >Slug (URL)</label
                    >
                    <input
                        type="text"
                        id="slug"
                        class="w-full px-3 py-2 bg-gray-50 text-gray-600 rounded-lg border border-gray-200 text-sm font-mono focus:ring-2 focus:ring-primary outline-none"
                        value={article?.slug || ""}
                        data-modified={isEdit ? "true" : ""}
                    />
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1"
                        >‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label
                    >
                    <select
                        id="category"
                        class="w-full px-3 py-2 rounded-lg border border-gray-200 bg-white focus:ring-2 focus:ring-primary outline-none"
                    >
                        <option value="uncategorized">‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>
                        {
                            categories.map((c: any) => (
                                <option
                                    value={c.slug}
                                    selected={article?.category === c.slug}
                                >
                                    {c.name}
                                </option>
                            ))
                        }
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1"
                        >‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label
                    >
                    <select
                        id="status"
                        class="w-full px-3 py-2 rounded-lg border border-gray-200 bg-white focus:ring-2 focus:ring-primary outline-none"
                    >
                        <option
                            value="draft"
                            selected={article?.status === "draft"}
                            >‡πÅ‡∏ö‡∏ö‡∏£‡πà‡∏≤‡∏á (Draft)</option
                        >
                        <option
                            value="published"
                            selected={article?.status === "published"}
                            >‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà (Published)</option
                        >
                    </select>
                </div>
            </div>

            <!-- Cover Image -->
            <div
                class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm space-y-4"
            >
                <h3 class="font-bold text-gray-800">‡∏£‡∏π‡∏õ‡∏õ‡∏Å (Cover Image)</h3>

                <div
                    id="dropzone"
                    class="border-2 border-dashed border-gray-300 rounded-xl p-4 text-center cursor-pointer hover:bg-gray-50 transition-colors relative group"
                >
                    <input
                        type="file"
                        id="cover-upload"
                        class="hidden"
                        accept="image/*"
                    />
                    <div
                        id="cover-preview"
                        class={article?.cover_image ? "" : "hidden"}
                    >
                        <img
                            src={article?.cover_image || ""}
                            id="preview-img"
                            class="w-full h-40 object-cover rounded-lg"
                        />
                        <button
                            id="remove-cover"
                            class="absolute top-2 right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"
                            >√ó</button
                        >
                    </div>
                    <div
                        id="upload-placeholder"
                        class={article?.cover_image ? "hidden" : "py-8"}
                    >
                        <div class="text-4xl mb-2">üì∑</div>
                        <p class="text-sm text-gray-500">
                            ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
                        </p>
                    </div>
                </div>
                <input
                    type="hidden"
                    id="cover_image"
                    value={article?.cover_image || ""}
                />
            </div>
        </div>
    </div>
</AdminLayout>

<script define:vars={{ id, isEdit }}>
    import {
        createArticle,
        updateArticle,
        uploadImage,
    } from "../../../lib/api";

    // Initialize Quill with retry mechanism
    function initQuill() {
        if (typeof Quill === "undefined") {
            setTimeout(initQuill, 100);
            return;
        }

        const toolbarOptions = [
            [{ header: [1, 2, 3, false] }],
            ["bold", "italic", "underline", "strike"],
            ["blockquote", "code-block"],
            [{ list: "ordered" }, { list: "bullet" }],
            [{ color: [] }, { background: [] }],
            ["link", "image", "video"],
            ["clean"],
        ];

        window.quill = new Quill("#editor-container", {
            theme: "snow",
            modules: {
                toolbar: {
                    container: toolbarOptions,
                    handlers: {
                        image: imageHandler,
                    },
                },
            },
            placeholder: "‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...",
        });

        // Set initial content
        const contentInput = document.getElementById("content");
        if (contentInput && contentInput.value) {
            window.quill.root.innerHTML = contentInput.value;
        }
    }

    // Load Quill Script dynamically if not present
    if (!document.getElementById("quill-script")) {
        const script = document.createElement("script");
        script.id = "quill-script";
        script.src = "https://cdn.quilljs.com/1.3.6/quill.js";
        script.onload = initQuill;
        document.head.appendChild(script);
    } else {
        initQuill();
    }

    // Custom Image Handler for Quill
    function imageHandler() {
        const input = document.createElement("input");
        input.setAttribute("type", "file");
        input.setAttribute("accept", "image/*");
        input.click();

        input.onchange = async () => {
            const file = input.files[0];
            if (/^image\//.test(file.type)) {
                try {
                    // Upload to server
                    const result = await uploadImage(file);
                    const range = window.quill.getSelection();

                    // Insert image into editor
                    // Use API_BASE_URL prefix if needed, but since we modify API_BASE_URL in api.ts locally,
                    // and upload returns /uploads/..., we might need full URL if frontend/backend distinct domains
                    // Assuming relative is fine or api returns full relative path. // Ideally absolute for safe rendering everywhere
                    // For now, let's use the returned url directly (likely /uploads/...)
                    // If frontend is on 4321 and backend 3000, we need to prepend API_URL if it's served by backend static
                    // Let's assume user visits 4321, /uploads is NOT proxy to 3000 unless configured in Astro config.
                    // Important: Astro doesn't proxy /uploads by default.
                    // So we must prepend API_BASE_URL to the image src.

                    // Actually, let's hardcode localhost:3000 for now or fetch from env.
                    // Or better, let's make a proxy in astro config for /uploads -> localhost:3000.
                    // But easier is strictly full URL.

                    // Current setup: Frontend 4321, Backend 3000.
                    // Image URL from API: /uploads/xxx.jpg
                    // Need: http://localhost:3000/uploads/xxx.jpg

                    const fullUrl = `http://localhost:3000${result.url}`; // TODO: Use robust env var

                    window.quill.insertEmbed(range.index, "image", fullUrl);
                } catch (e) {
                    console.error("Upload failed:", e);
                    alert("‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
                }
            } else {
                alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô");
            }
        };
    }

    // Slug Generator
    window.generateSlug = (value) => {
        const slugInput = document.getElementById("slug");
        if (
            !slugInput.value ||
            slugInput.getAttribute("data-modified") !== "true"
        ) {
            slugInput.value = value
                .toLowerCase()
                .replace(/ /g, "-")
                .replace(/[^\w-]+/g, "") // Keep thai chars? No, simple slug usually ascii.
                // If Thai, maybe keep it?
                // For simplicity, let's keep only basic ASCII. If user wants thai slug, they type it manually.
                // Or better, simple regex that creates safe URL.
                .replace(/[^\w\u0E00-\u0E7F\-]+/g, ""); // Allow Thai chars
        }
    };

    document.getElementById("slug")?.addEventListener("input", function () {
        this.setAttribute("data-modified", "true");
    });

    // Cover Image Upload logic
    const dropzone = document.getElementById("dropzone");
    const coverInput = document.getElementById("cover-upload");
    const coverPreview = document.getElementById("cover-preview");
    const previewImg = document.getElementById("preview-img");
    const uploadPlaceholder = document.getElementById("upload-placeholder");
    const removeCoverBtn = document.getElementById("remove-cover");
    const coverValueInput = document.getElementById("cover_image");

    if (dropzone) {
        dropzone.onclick = (e) => {
            if (e.target !== removeCoverBtn) coverInput.click();
        };
    }

    if (coverInput) {
        coverInput.onchange = async (e) => {
            const file = e.target.files[0];
            if (file) {
                try {
                    const result = await uploadImage(file);
                    const fullUrl = `http://localhost:3000${result.url}`;
                    previewImg.src = fullUrl;
                    coverValueInput.value = fullUrl;

                    coverPreview.classList.remove("hidden");
                    uploadPlaceholder.classList.add("hidden");
                } catch (error) {
                    alert("‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
                }
            }
        };
    }

    if (removeCoverBtn) {
        removeCoverBtn.onclick = () => {
            coverValueInput.value = "";
            previewImg.src = "";
            coverPreview.classList.add("hidden");
            uploadPlaceholder.classList.remove("hidden");
            coverInput.value = ""; // Reset input
        };
    }

    // Save Logic
    const saveBtn = document.getElementById("save-btn");
    if (saveBtn) {
        saveBtn.onclick = async () => {
            const title = document.getElementById("title").value;
            const slug = document.getElementById("slug").value;
            const category = document.getElementById("category").value;
            const status = document.getElementById("status").value;
            const cover_image = document.getElementById("cover_image").value;

            // Get content safely
            const content = window.quill ? window.quill.root.innerHTML : "";

            if (!title || !slug) {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÅ‡∏•‡∏∞ Slug");
                return;
            }

            const data = {
                title,
                slug,
                category,
                status,
                cover_image,
                content,
            };
            console.log("Saving article:", data);

            try {
                if (isEdit) {
                    await updateArticle(id, data);
                    alert("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
                } else {
                    await createArticle(data);
                    alert("‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
                }
                window.location.href = "/admin/articles";
            } catch (e) {
                console.error(e);
                alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + e.message);
            }
        };
    }
</script>

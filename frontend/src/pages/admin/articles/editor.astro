---
import AdminLayout from "../../../layouts/AdminLayout.astro";
import { API_BASE_URL } from "../../../lib/api";

const id = Astro.url.searchParams.get("id");
const isEdit = !!id;

// Fetch article data if editing
let article: any = null;
let categories: any[] = [];

try {
    // Fetch categories
    const catRes = await fetch(`${API_BASE_URL}/api/categories`);
    if (catRes.ok) {
        const catData = await catRes.json();
        categories = catData.categories || [];
    }

    // Fetch article if editing
    if (id) {
        const artRes = await fetch(`${API_BASE_URL}/api/articles/${id}`);
        if (artRes.ok) {
            article = await artRes.json();
        }
    }
} catch (e) {
    console.error("Error loading editor data:", e);
}
---

<AdminLayout title={isEdit ? "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°" : "‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà"}>
    <style>
        .editor-card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
        }
        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
        }
        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            font-size: 1rem;
            transition:
                border-color 0.2s,
                box-shadow 0.2s;
        }
        .form-input:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }
        .btn-primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition:
                transform 0.2s,
                box-shadow 0.2s;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }
        .btn-secondary {
            background: white;
            color: #6b7280;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 500;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            transition: background 0.2s;
        }
        .btn-secondary:hover {
            background: #f9fafb;
        }
        .tox-tinymce {
            border-radius: 0.5rem !important;
            border: 1px solid #e5e7eb !important;
        }
        .cover-dropzone {
            border: 2px dashed #d1d5db;
            border-radius: 0.75rem;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition:
                border-color 0.2s,
                background 0.2s;
        }
        .cover-dropzone:hover {
            border-color: #10b981;
            background: #f0fdf4;
        }
        .cover-preview {
            position: relative;
            border-radius: 0.75rem;
            overflow: hidden;
        }
        .cover-preview img {
            width: 100%;
            height: 160px;
            object-fit: cover;
        }
        .cover-remove {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>

    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-gray-800">
            {isEdit ? "‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°" : "üìù ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà"}
        </h1>
        <div class="flex gap-3">
            <a href="/admin/articles" class="btn-secondary">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</a>
            <button id="save-btn" class="btn-primary">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
    </div>

    <!-- Editor Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Main Content -->
        <div class="lg:col-span-2 space-y-6">
            <div class="editor-card">
                <label class="form-label">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°</label>
                <input
                    type="text"
                    id="title"
                    class="form-input text-xl font-semibold"
                    placeholder="‡πÉ‡∏™‡πà‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."
                    value={article?.title || ""}
                />
            </div>

            <div class="editor-card">
                <label class="form-label">‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤</label>
                <textarea id="content" style="min-height: 400px;"
                    >{article?.content || ""}</textarea
                >
            </div>
        </div>

        <!-- Sidebar -->
        <div class="space-y-6">
            <!-- Settings -->
            <div class="editor-card space-y-4">
                <h3 class="font-bold text-gray-800">‚öôÔ∏è ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</h3>

                <div>
                    <label class="form-label">Slug (URL)</label>
                    <input
                        type="text"
                        id="slug"
                        class="form-input font-mono text-sm"
                        placeholder="article-slug"
                        value={article?.slug || ""}
                    />
                </div>

                <div>
                    <label class="form-label">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                    <select id="category" class="form-input">
                        <option value="uncategorized">‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>
                        {
                            categories.map((c: any) => (
                                <option
                                    value={c.slug}
                                    selected={article?.category === c.slug}
                                >
                                    {c.name}
                                </option>
                            ))
                        }
                    </select>
                </div>

                <div>
                    <label class="form-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                    <select id="status" class="form-input">
                        <option
                            value="draft"
                            selected={article?.status === "draft"}
                            >üìù ‡πÅ‡∏ö‡∏ö‡∏£‡πà‡∏≤‡∏á</option
                        >
                        <option
                            value="published"
                            selected={article?.status === "published"}
                            >‚úÖ ‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà</option
                        >
                    </select>
                </div>
            </div>

            <!-- Cover Image -->
            <div class="editor-card space-y-4">
                <h3 class="font-bold text-gray-800">üñºÔ∏è ‡∏£‡∏π‡∏õ‡∏õ‡∏Å</h3>

                <div id="cover-wrapper">
                    <div id="cover-dropzone" class="cover-dropzone">
                        <input
                            type="file"
                            id="cover-input"
                            accept="image/*"
                            class="hidden"
                        />
                        <div class="text-4xl mb-2">üì∑</div>
                        <p class="text-sm text-gray-500">
                            ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
                        </p>
                    </div>
                    <div id="cover-preview" class="cover-preview hidden">
                        <img
                            id="cover-img"
                            src={article?.cover_image || ""}
                            alt="Cover"
                        />
                        <button id="cover-remove" class="cover-remove">√ó</button
                        >
                    </div>
                </div>
                <input
                    type="hidden"
                    id="cover_image"
                    value={article?.cover_image || ""}
                />
            </div>
        </div>
    </div>

    <!-- TinyMCE CDN -->
    <script
        is:inline
        src="https://cdn.tiny.cloud/1/4o3zqqgy417yz3i7q2pwiph5qcftrg07mx1csfkhncpdhsgl/tinymce/6/tinymce.min.js"
        referrerpolicy="origin"></script>

    <!-- Page Script -->
    <script is:inline define:vars={{ id, isEdit, API_BASE_URL }}>
        // Initialize TinyMCE
        function initTinyMCE() {
            if (typeof tinymce === "undefined") {
                console.log("Waiting for TinyMCE...");
                setTimeout(initTinyMCE, 200);
                return;
            }

            tinymce.init({
                selector: "#content",
                height: 450,
                menubar: false,
                plugins: "lists link image table code fullscreen preview",
                toolbar:
                    "undo redo | blocks | bold italic underline | alignleft aligncenter alignright | bullist numlist | link image | code fullscreen",
                content_style:
                    "body { font-family: Sarabun, sans-serif; font-size: 16px; line-height: 1.8; }",
                placeholder: "‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...",
                branding: false,
                promotion: false,
                setup: function (editor) {
                    editor.on("init", function () {
                        console.log("TinyMCE initialized successfully");
                    });
                },
            });
        }

        document.addEventListener("DOMContentLoaded", function () {
            initTinyMCE();

            // Auto-generate slug from title
            const titleInput = document.getElementById("title");
            const slugInput = document.getElementById("slug");
            let slugEdited = !!slugInput.value;

            titleInput.addEventListener("input", function () {
                if (!slugEdited) {
                    slugInput.value = this.value
                        .toLowerCase()
                        .replace(/\s+/g, "-")
                        .replace(/[^a-z0-9\-]/g, "")
                        .substring(0, 100);
                }
            });

            slugInput.addEventListener("input", function () {
                slugEdited = true;
            });

            // Cover image upload
            const dropzone = document.getElementById("cover-dropzone");
            const coverInput = document.getElementById("cover-input");
            const coverPreview = document.getElementById("cover-preview");
            const coverImg = document.getElementById("cover-img");
            const coverRemove = document.getElementById("cover-remove");
            const coverValue = document.getElementById("cover_image");

            dropzone.addEventListener("click", () => coverInput.click());

            coverInput.addEventListener("change", async function (e) {
                const file = e.target.files[0];
                if (!file) return;

                const formData = new FormData();
                formData.append("file", file);

                try {
                    const res = await fetch(API_BASE_URL + "/api/upload", {
                        method: "POST",
                        body: formData,
                    });
                    if (!res.ok) throw new Error("Upload failed");
                    const data = await res.json();
                    const url = API_BASE_URL + data.url;

                    coverImg.src = url;
                    coverValue.value = url;
                    dropzone.classList.add("hidden");
                    coverPreview.classList.remove("hidden");
                } catch (err) {
                    alert("‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message);
                }
            });

            coverRemove.addEventListener("click", function () {
                coverImg.src = "";
                coverValue.value = "";
                coverPreview.classList.add("hidden");
                dropzone.classList.remove("hidden");
                coverInput.value = "";
            });

            // Show preview if cover exists
            if (coverValue.value) {
                dropzone.classList.add("hidden");
                coverPreview.classList.remove("hidden");
            }

            // Save article
            document
                .getElementById("save-btn")
                .addEventListener("click", async function () {
                    const title = document.getElementById("title").value.trim();
                    const slug = document.getElementById("slug").value.trim();
                    const category = document.getElementById("category").value;
                    const status = document.getElementById("status").value;
                    const cover_image =
                        document.getElementById("cover_image").value;

                    // Get content from TinyMCE
                    const content = tinymce.get("content")
                        ? tinymce.get("content").getContent()
                        : "";

                    if (!title) {
                        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°");
                        return;
                    }
                    if (!slug) {
                        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏ Slug");
                        return;
                    }

                    const payload = {
                        title,
                        slug,
                        category,
                        status,
                        cover_image,
                        content,
                    };
                    console.log("Saving:", payload);

                    try {
                        const url = isEdit
                            ? API_BASE_URL + "/api/articles/" + id
                            : API_BASE_URL + "/api/articles";

                        const res = await fetch(url, {
                            method: isEdit ? "PUT" : "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(payload),
                        });

                        if (!res.ok) {
                            const err = await res.json();
                            throw new Error(err.error || "Failed to save");
                        }

                        alert(
                            isEdit
                                ? "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"
                                : "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢",
                        );
                        window.location.href = "/admin/articles";
                    } catch (err) {
                        alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message);
                    }
                });
        });
    </script>
</AdminLayout>

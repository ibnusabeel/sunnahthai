---
import AdminLayout from "../../layouts/AdminLayout.astro";
import StatCard from "../../components/admin/StatCard.astro";
import { getBooks, getDynamicBookNames, BOOK_NAMES } from "../../lib/api";

// Fetch all books with their stats
let booksList: any[] = [];
try {
    const res = await getBooks();
    booksList = res.books;
} catch (e) {
    console.error("Failed to fetch books:", e);
}

// Fetch dynamic names
let bookNames = { ...BOOK_NAMES };
try {
    const dynamicNames = await getDynamicBookNames();
    bookNames = { ...bookNames, ...dynamicNames };
} catch (e) {
    console.error(e);
}

// Calculate Overall Totals
const totalHadiths = booksList.reduce((acc, b) => acc + (b.total || 0), 0);
const totalTranslated = booksList.reduce(
    (acc, b) => acc + (b.translated || 0),
    0,
);
const totalPending = totalHadiths - totalTranslated;
const percentage =
    totalHadiths > 0 ? Math.round((totalTranslated / totalHadiths) * 100) : 0;

// Enrich booksList with Names
const enrichedBooks = booksList.map((b) => {
    const info = bookNames[b.book];
    return {
        ...b,
        th: info?.th || b.book,
        ar: info?.ar || "",
        key: b.book, // Keep key for reference
    };
});
---

<AdminLayout title="‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° (Dashboard)">
    <!-- Stats Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <StatCard
            title="‡∏´‡∏∞‡∏î‡∏µ‡∏©‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"
            value={totalHadiths.toLocaleString()}
            icon="üìö"
            color="blue"
        />
        <StatCard
            title="‡πÅ‡∏õ‡∏•‡πÅ‡∏•‡πâ‡∏ß"
            value={totalTranslated.toLocaleString()}
            icon="‚úÖ"
            color="green"
            subtitle={`${percentage}% ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå`}
        />
        <StatCard
            title="‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•"
            value={totalPending.toLocaleString()}
            icon="‚è≥"
            color="orange"
        />
        <StatCard
            title="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏•‡πà‡∏°"
            value={booksList.length}
            icon="üìñ"
            color="purple"
        />
    </div>

    <!-- Recent Activity / Book Progress -->
    <div
        class="bg-white rounded-2xl border border-gray-100 shadow-sm overflow-hidden"
    >
        <div
            class="px-6 py-4 border-b border-gray-100 flex items-center justify-between"
        >
            <h3 class="font-bold text-gray-800">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏•‡πà‡∏°</h3>
            <a href="/admin/books" class="text-sm text-primary hover:underline"
                >‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‚Üí</a
            >
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-left">
                <thead class="bg-gray-50 text-gray-500 text-xs uppercase">
                    <tr>
                        <th class="px-6 py-3">‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</th>
                        <th class="px-6 py-3 text-center">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</th>
                        <th class="px-6 py-3 text-right">‡πÅ‡∏õ‡∏•‡πÅ‡∏•‡πâ‡∏ß</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    {
                        enrichedBooks.map((book) => (
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4">
                                    <div class="font-medium text-gray-800">
                                        {book.th}
                                    </div>
                                    <div class="text-xs text-gray-400">
                                        {book.ar}
                                    </div>
                                </td>
                                <td class="px-6 py-4 w-1/3">
                                    <div class="flex items-center gap-2">
                                        <span class="text-xs font-bold w-8 text-right">
                                            {book.percentage}%
                                        </span>
                                        <div class="w-full bg-gray-100 rounded-full h-2">
                                            <div
                                                class="bg-primary h-2 rounded-full"
                                                style={`width: ${book.percentage}%`}
                                            />
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 text-right text-sm text-gray-600">
                                    {book.translated.toLocaleString()} /{" "}
                                    {book.total.toLocaleString()}
                                </td>
                            </tr>
                        ))
                    }
                </tbody>
            </table>
        </div>
    </div>
</AdminLayout>

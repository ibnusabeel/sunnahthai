---
import AdminLayout from "../../layouts/AdminLayout.astro";
import { API_BASE_URL } from "../../lib/api";
---

<AdminLayout title="à¸ˆà¸±à¸”à¸à¸²à¸£à¸•à¸±à¸Ÿà¸‹à¸µà¸£à¸­à¸±à¸‹-à¸‹à¸°à¸­à¹Œà¸”à¸µà¸¢à¹Œ">
    <style>
        .editor-card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
        }
        .form-select {
            padding: 0.75rem 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            font-size: 1rem;
        }
        .form-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .modal-content {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .arabic-text {
            font-family: "KFGQPC Hafs", serif;
            font-size: 1.25rem;
            line-height: 2;
            text-align: right;
        }
        :global(.rte-wrapper) {
            max-width: 100% !important;
        }
    </style>

    <!-- Stats Card -->
    <div
        id="stats-card"
        class="bg-gradient-to-r from-blue-500 to-cyan-500 rounded-2xl p-6 text-white mb-6"
    >
        <h2 class="text-xl font-bold mb-4">ğŸ“˜ à¸•à¸±à¸Ÿà¸‹à¸µà¸£à¸­à¸±à¸‹-à¸‹à¸°à¸­à¹Œà¸”à¸µà¸¢à¹Œ</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="bg-white/20 rounded-xl p-4 text-center">
                <div id="stat-total" class="text-3xl font-bold">-</div>
                <div class="text-sm opacity-80">à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”</div>
            </div>
            <div class="bg-white/20 rounded-xl p-4 text-center">
                <div
                    id="stat-translated"
                    class="text-3xl font-bold text-green-200"
                >
                    -
                </div>
                <div class="text-sm opacity-80">à¹à¸›à¸¥à¹à¸¥à¹‰à¸§</div>
            </div>
            <div class="bg-white/20 rounded-xl p-4 text-center">
                <div
                    id="stat-untranslated"
                    class="text-3xl font-bold text-yellow-200"
                >
                    -
                </div>
                <div class="text-sm opacity-80">à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¹à¸›à¸¥</div>
            </div>
            <div class="bg-white/20 rounded-xl p-4 text-center">
                <div id="stat-percent" class="text-3xl font-bold">-</div>
                <div class="text-sm opacity-80">à¸„à¸§à¸²à¸¡à¸„à¸·à¸šà¸«à¸™à¹‰à¸²</div>
            </div>
        </div>
    </div>

    <!-- Surah Selector -->
    <div class="editor-card mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-2"
            >à¹€à¸¥à¸·à¸­à¸à¸ªà¸¹à¹€à¸£à¸²à¸°à¸®à¸º</label
        >
        <select id="surah-select" class="form-select w-full md:w-auto">
            <!-- Populated by JS -->
        </select>
    </div>

    <!-- Entries Table -->
    <div
        class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden"
    >
        <div id="entries-list" class="overflow-x-auto">
            <div class="p-8 text-center text-gray-500">à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”...</div>
        </div>
    </div>

    <!-- Pagination -->
    <div id="pagination" class="flex justify-center gap-2 mt-6 hidden">
        <button
            id="prev-btn"
            class="px-4 py-2 bg-gray-100 rounded-lg hover:bg-gray-200 disabled:opacity-50"
            >â† à¸à¹ˆà¸­à¸™à¸«à¸™à¹‰à¸²</button
        >
        <span
            id="page-info"
            class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg"
            >à¸«à¸™à¹‰à¸² 1 / 1</span
        >
        <button
            id="next-btn"
            class="px-4 py-2 bg-gray-100 rounded-lg hover:bg-gray-200 disabled:opacity-50"
            >à¸–à¸±à¸”à¹„à¸› â†’</button
        >
    </div>

    <!-- Hidden config -->
    <div id="config" data-api-url={API_BASE_URL} class="hidden"></div>

    <!-- Edit Modal -->
    <div
        id="edit-modal"
        class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm"
    >
        <div
            class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col m-4 animate-in fade-in zoom-in duration-200"
        >
            <div
                class="p-4 border-b flex justify-between items-center bg-gray-50"
            >
                <div>
                    <h3
                        class="font-bold text-lg text-gray-800 flex items-center gap-2"
                    >
                        <span>âœï¸</span> à¹à¸à¹‰à¹„à¸‚à¸„à¸³à¹à¸›à¸¥
                    </h3>
                    <p id="modal-ayah-info" class="text-sm text-gray-600 mt-1">
                        à¸ªà¸¹à¹€à¸£à¸²à¸°à¸®à¸º ...
                    </p>
                </div>
                <button
                    id="modal-close"
                    class="text-gray-400 hover:text-red-500 text-3xl px-2 leading-none transition-colors"
                    >&times;</button
                >
            </div>

            <div class="p-6 flex-1 overflow-y-auto bg-white">
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2"
                        >à¸ à¸²à¸©à¸²à¸­à¸²à¸«à¸£à¸±à¸š</label
                    >
                    <div
                        id="modal-arabic"
                        class="p-4 bg-gray-50 border border-gray-100 rounded-lg text-right text-xl leading-loose font-arabic text-gray-800"
                    >
                    </div>
                </div>

                <div class="mb-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2"
                        >à¸„à¸³à¹à¸›à¸¥à¸ à¸²à¸©à¸²à¹„à¸—à¸¢</label
                    >
                    <!-- Formatting Toolbar hint -->
                    <div id="editor-container" class="bg-white rounded-lg">
                    </div>
                </div>
            </div>

            <div
                class="p-4 border-t bg-gray-50 flex justify-end gap-3 sticky bottom-0"
            >
                <button
                    id="modal-cancel"
                    class="px-5 py-2.5 text-gray-700 hover:bg-gray-200 rounded-lg font-medium transition-colors"
                    >à¸¢à¸à¹€à¸¥à¸´à¸</button
                >
                <button
                    id="modal-save"
                    class="px-6 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium shadow-sm transition-colors flex items-center gap-2"
                >
                    <span>ğŸ’¾</span> à¸šà¸±à¸™à¸—à¸¶à¸
                </button>
            </div>
        </div>
    </div>

    <!-- Quill CSS -->
    <link
        href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css"
        rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.js"
    ></script>

    <script is:inline>
        var configEl = document.getElementById("config");
        var API_URL =
            configEl && configEl.dataset.apiUrl
                ? configEl.dataset.apiUrl
                : "http://localhost:3000";

        var surahNames = [
            "Ø§Ù„ÙØ§ØªØ­Ø©",
            "Ø§Ù„Ø¨Ù‚Ø±Ø©",
            "Ø¢Ù„ Ø¹Ù…Ø±Ø§Ù†",
            "Ø§Ù„Ù†Ø³Ø§Ø¡",
            "Ø§Ù„Ù…Ø§Ø¦Ø¯Ø©",
            "Ø§Ù„Ø£Ù†Ø¹Ø§Ù…",
            "Ø§Ù„Ø£Ø¹Ø±Ø§Ù",
            "Ø§Ù„Ø£Ù†ÙØ§Ù„",
            "Ø§Ù„ØªÙˆØ¨Ø©",
            "ÙŠÙˆÙ†Ø³",
            "Ù‡ÙˆØ¯",
            "ÙŠÙˆØ³Ù",
            "Ø§Ù„Ø±Ø¹Ø¯",
            "Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…",
            "Ø§Ù„Ø­Ø¬Ø±",
            "Ø§Ù„Ù†Ø­Ù„",
            "Ø§Ù„Ø¥Ø³Ø±Ø§Ø¡",
            "Ø§Ù„ÙƒÙ‡Ù",
            "Ù…Ø±ÙŠÙ…",
            "Ø·Ù‡",
            "Ø§Ù„Ø£Ù†Ø¨ÙŠØ§Ø¡",
            "Ø§Ù„Ø­Ø¬",
            "Ø§Ù„Ù…Ø¤Ù…Ù†ÙˆÙ†",
            "Ø§Ù„Ù†ÙˆØ±",
            "Ø§Ù„ÙØ±Ù‚Ø§Ù†",
            "Ø§Ù„Ø´Ø¹Ø±Ø§Ø¡",
            "Ø§Ù„Ù†Ù…Ù„",
            "Ø§Ù„Ù‚ØµØµ",
            "Ø§Ù„Ø¹Ù†ÙƒØ¨ÙˆØª",
            "Ø§Ù„Ø±ÙˆÙ…",
            "Ù„Ù‚Ù…Ø§Ù†",
            "Ø§Ù„Ø³Ø¬Ø¯Ø©",
            "Ø§Ù„Ø£Ø­Ø²Ø§Ø¨",
            "Ø³Ø¨Ø£",
            "ÙØ§Ø·Ø±",
            "ÙŠØ³",
            "Ø§Ù„ØµØ§ÙØ§Øª",
            "Øµ",
            "Ø§Ù„Ø²Ù…Ø±",
            "ØºØ§ÙØ±",
            "ÙØµÙ„Øª",
            "Ø§Ù„Ø´ÙˆØ±Ù‰",
            "Ø§Ù„Ø²Ø®Ø±Ù",
            "Ø§Ù„Ø¯Ø®Ø§Ù†",
            "Ø§Ù„Ø¬Ø§Ø«ÙŠØ©",
            "Ø§Ù„Ø£Ø­Ù‚Ø§Ù",
            "Ù…Ø­Ù…Ø¯",
            "Ø§Ù„ÙØªØ­",
            "Ø§Ù„Ø­Ø¬Ø±Ø§Øª",
            "Ù‚",
            "Ø§Ù„Ø°Ø§Ø±ÙŠØ§Øª",
            "Ø§Ù„Ø·ÙˆØ±",
            "Ø§Ù„Ù†Ø¬Ù…",
            "Ø§Ù„Ù‚Ù…Ø±",
            "Ø§Ù„Ø±Ø­Ù…Ù†",
            "Ø§Ù„ÙˆØ§Ù‚Ø¹Ø©",
            "Ø§Ù„Ø­Ø¯ÙŠØ¯",
            "Ø§Ù„Ù…Ø¬Ø§Ø¯Ù„Ø©",
            "Ø§Ù„Ø­Ø´Ø±",
            "Ø§Ù„Ù…Ù…ØªØ­Ù†Ø©",
            "Ø§Ù„ØµÙ",
            "Ø§Ù„Ø¬Ù…Ø¹Ø©",
            "Ø§Ù„Ù…Ù†Ø§ÙÙ‚ÙˆÙ†",
            "Ø§Ù„ØªØºØ§Ø¨Ù†",
            "Ø§Ù„Ø·Ù„Ø§Ù‚",
            "Ø§Ù„ØªØ­Ø±ÙŠÙ…",
            "Ø§Ù„Ù…Ù„Ùƒ",
            "Ø§Ù„Ù‚Ù„Ù…",
            "Ø§Ù„Ø­Ø§Ù‚Ø©",
            "Ø§Ù„Ù…Ø¹Ø§Ø±Ø¬",
            "Ù†ÙˆØ­",
            "Ø§Ù„Ø¬Ù†",
            "Ø§Ù„Ù…Ø²Ù…Ù„",
            "Ø§Ù„Ù…Ø¯Ø«Ø±",
            "Ø§Ù„Ù‚ÙŠØ§Ù…Ø©",
            "Ø§Ù„Ø¥Ù†Ø³Ø§Ù†",
            "Ø§Ù„Ù…Ø±Ø³Ù„Ø§Øª",
            "Ø§Ù„Ù†Ø¨Ø£",
            "Ø§Ù„Ù†Ø§Ø²Ø¹Ø§Øª",
            "Ø¹Ø¨Ø³",
            "Ø§Ù„ØªÙƒÙˆÙŠØ±",
            "Ø§Ù„Ø§Ù†ÙØ·Ø§Ø±",
            "Ø§Ù„Ù…Ø·ÙÙÙŠÙ†",
            "Ø§Ù„Ø§Ù†Ø´Ù‚Ø§Ù‚",
            "Ø§Ù„Ø¨Ø±ÙˆØ¬",
            "Ø§Ù„Ø·Ø§Ø±Ù‚",
            "Ø§Ù„Ø£Ø¹Ù„Ù‰",
            "Ø§Ù„ØºØ§Ø´ÙŠØ©",
            "Ø§Ù„ÙØ¬Ø±",
            "Ø§Ù„Ø¨Ù„Ø¯",
            "Ø§Ù„Ø´Ù…Ø³",
            "Ø§Ù„Ù„ÙŠÙ„",
            "Ø§Ù„Ø¶Ø­Ù‰",
            "Ø§Ù„Ø´Ø±Ø­",
            "Ø§Ù„ØªÙŠÙ†",
            "Ø§Ù„Ø¹Ù„Ù‚",
            "Ø§Ù„Ù‚Ø¯Ø±",
            "Ø§Ù„Ø¨ÙŠÙ†Ø©",
            "Ø§Ù„Ø²Ù„Ø²Ù„Ø©",
            "Ø§Ù„Ø¹Ø§Ø¯ÙŠØ§Øª",
            "Ø§Ù„Ù‚Ø§Ø±Ø¹Ø©",
            "Ø§Ù„ØªÙƒØ§Ø«Ø±",
            "Ø§Ù„Ø¹ØµØ±",
            "Ø§Ù„Ù‡Ù…Ø²Ø©",
            "Ø§Ù„ÙÙŠÙ„",
            "Ù‚Ø±ÙŠØ´",
            "Ø§Ù„Ù…Ø§Ø¹ÙˆÙ†",
            "Ø§Ù„ÙƒÙˆØ«Ø±",
            "Ø§Ù„ÙƒØ§ÙØ±ÙˆÙ†",
            "Ø§Ù„Ù†ØµØ±",
            "Ø§Ù„Ù…Ø³Ø¯",
            "Ø§Ù„Ø¥Ø®Ù„Ø§Øµ",
            "Ø§Ù„ÙÙ„Ù‚",
            "Ø§Ù„Ù†Ø§Ø³",
        ];

        var currentSurah = 1;
        var currentPage = 1;
        var totalPages = 1;
        var editingId = null;
        var quill = null;

        function initSurahSelect() {
            var select = document.getElementById("surah-select");
            surahNames.forEach(function (name, i) {
                var option = document.createElement("option");
                option.value = String(i + 1);
                option.textContent = i + 1 + ". " + name;
                select.appendChild(option);
            });
            select.addEventListener("change", function () {
                currentSurah = parseInt(select.value);
                currentPage = 1;
                fetchEntries();
            });
        }

        function fetchStats() {
            fetch(API_URL + "/api/admin/tafsir-assadi/stats")
                .then(function (res) {
                    return res.json();
                })
                .then(function (data) {
                    document.getElementById("stat-total").textContent =
                        data.total.toLocaleString();
                    document.getElementById("stat-translated").textContent =
                        data.translated.toLocaleString();
                    document.getElementById("stat-untranslated").textContent =
                        data.untranslated.toLocaleString();
                    document.getElementById("stat-percent").textContent =
                        data.percentage + "%";
                })
                .catch(function (e) {
                    console.error("Failed to fetch stats:", e);
                });
        }

        function fetchEntries() {
            var container = document.getElementById("entries-list");
            container.innerHTML =
                '<div class="p-8 text-center text-gray-500">à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”...</div>';

            fetch(
                API_URL +
                    "/api/admin/tafsir-assadi?surah=" +
                    currentSurah +
                    "&page=" +
                    currentPage +
                    "&limit=20",
            )
                .then(function (res) {
                    return res.json();
                })
                .then(function (data) {
                    totalPages = data.pages;

                    if (data.entries.length === 0) {
                        container.innerHTML =
                            '<div class="p-8 text-center text-gray-500">à¹„à¸¡à¹ˆà¸à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥</div>';
                        return;
                    }

                    // Build table
                    var tableHTML =
                        '<table class="w-full text-left">' +
                        '<thead class="bg-gray-50 text-gray-500 text-xs uppercase font-semibold">' +
                        "<tr>" +
                        '<th class="px-4 py-3 w-20">à¸­à¸²à¸¢à¸°à¸®à¸º</th>' +
                        '<th class="px-4 py-3 w-24 text-center">à¸ªà¸–à¸²à¸™à¸°</th>' +
                        '<th class="px-4 py-3 text-right" style="min-width:200px">à¸­à¸²à¸«à¸£à¸±à¸š</th>' +
                        '<th class="px-4 py-3" style="min-width:250px">à¸„à¸³à¹à¸›à¸¥à¹„à¸—à¸¢</th>' +
                        '<th class="px-4 py-3 w-24 text-right">à¸ˆà¸±à¸”à¸à¸²à¸£</th>' +
                        "</tr>" +
                        "</thead>" +
                        '<tbody class="divide-y divide-gray-100">';

                    data.entries.forEach(function (entry) {
                        var ayahRange =
                            entry.ayah_end !== entry.ayah_start
                                ? "-" + entry.ayah_end
                                : "";
                        var statusBadge = entry.text_th
                            ? '<span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full whitespace-nowrap">âœ“ à¹à¸›à¸¥à¹à¸¥à¹‰à¸§</span>'
                            : '<span class="px-2 py-1 bg-yellow-100 text-yellow-700 text-xs rounded-full whitespace-nowrap">à¸£à¸­à¹à¸›à¸¥</span>';
                        var thaiPreview = entry.text_th
                            ? '<span class="line-clamp-2" title="' +
                              entry.text_th
                                  .replace(/"/g, "&quot;")
                                  .replace(/<[^>]*>/g, "") +
                              '">' +
                              entry.text_th
                                  .replace(/<[^>]*>/g, "")
                                  .substring(0, 100) +
                              "</span>"
                            : '<span class="text-gray-400 italic">à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸„à¸³à¹à¸›à¸¥</span>';
                        var arabicPreview =
                            '<span class="line-clamp-2 font-arabic" dir="rtl" title="' +
                            entry.text_ar.replace(/"/g, "&quot;") +
                            '">' +
                            entry.text_ar.substring(0, 120) +
                            (entry.text_ar.length > 120 ? "..." : "") +
                            "</span>";

                        tableHTML +=
                            '<tr class="hover:bg-gray-50 transition-colors">' +
                            '<td class="px-4 py-3 text-sm font-medium text-blue-600 whitespace-nowrap align-middle">' +
                            entry.ayah_start +
                            ayahRange +
                            "</td>" +
                            '<td class="px-4 py-3 text-center align-middle">' +
                            statusBadge +
                            "</td>" +
                            '<td class="px-4 py-3 text-right text-base leading-relaxed text-gray-800 align-top">' +
                            arabicPreview +
                            "</td>" +
                            '<td class="px-4 py-3 text-sm leading-relaxed text-gray-700 align-top">' +
                            thaiPreview +
                            "</td>" +
                            '<td class="px-4 py-3 text-right align-middle">' +
                            '<button class="edit-btn text-blue-600 hover:text-blue-800 font-medium px-3 py-1.5 rounded-lg hover:bg-blue-50 transition-colors text-sm" ' +
                            'data-id="' +
                            entry.id +
                            '" ' +
                            'data-arabic="' +
                            encodeURIComponent(entry.text_ar) +
                            '" ' +
                            'data-thai="' +
                            encodeURIComponent(entry.text_th || "") +
                            '" ' +
                            'data-ayah-start="' +
                            entry.ayah_start +
                            '" ' +
                            'data-ayah-end="' +
                            entry.ayah_end +
                            '">' +
                            "âœï¸ à¹à¸à¹‰à¹„à¸‚" +
                            "</button>" +
                            "</td>" +
                            "</tr>";
                    });

                    tableHTML += "</tbody></table>";
                    container.innerHTML = tableHTML;

                    container
                        .querySelectorAll(".edit-btn")
                        .forEach(function (btn) {
                            btn.addEventListener("click", function (e) {
                                var target = e.currentTarget;
                                openEditModal(
                                    target.dataset.id,
                                    decodeURIComponent(target.dataset.arabic),
                                    decodeURIComponent(target.dataset.thai),
                                    parseInt(target.dataset.ayahStart),
                                    parseInt(target.dataset.ayahEnd),
                                );
                            });
                        });

                    updatePagination();
                })
                .catch(function (e) {
                    console.error("Failed to fetch entries:", e);
                    container.innerHTML =
                        '<div class="p-8 text-center text-red-500">à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”</div>';
                });
        }

        function updatePagination() {
            var pagination = document.getElementById("pagination");
            var pageInfo = document.getElementById("page-info");
            var prevBtn = document.getElementById("prev-btn");
            var nextBtn = document.getElementById("next-btn");

            if (totalPages > 1) {
                pagination.classList.remove("hidden");
                pageInfo.textContent =
                    "à¸«à¸™à¹‰à¸² " + currentPage + " / " + totalPages;
                prevBtn.disabled = currentPage === 1;
                nextBtn.disabled = currentPage === totalPages;
            } else {
                pagination.classList.add("hidden");
            }
        }

        function openEditModal(id, arabic, thai, ayahStart, ayahEnd) {
            editingId = id;
            var modal = document.getElementById("edit-modal");
            var ayahInfo =
                "à¸ªà¸¹à¹€à¸£à¸²à¸°à¸®à¸º " + currentSurah + " - à¸­à¸²à¸¢à¸°à¸®à¸º " + ayahStart;
            if (ayahEnd !== ayahStart) {
                ayahInfo += " à¸–à¸¶à¸‡ " + ayahEnd;
            }
            document.getElementById("modal-ayah-info").textContent = ayahInfo;
            document.getElementById("modal-arabic").textContent = arabic;

            // Setup Editor Container
            var container = document.getElementById("editor-container");
            container.innerHTML =
                '<div id="quill-editor" style="height: 300px;"></div>';

            modal.classList.remove("hidden");

            // Init Quill
            setTimeout(function () {
                if (document.getElementById("quill-editor")) {
                    quill = new Quill("#quill-editor", {
                        theme: "snow",
                        modules: {
                            toolbar: [
                                [
                                    { font: [] },
                                    { size: ["small", false, "large", "huge"] },
                                ],
                                ["bold", "italic", "underline", "strike"],
                                [{ color: [] }, { background: [] }],
                                [{ script: "sub" }, { script: "super" }],
                                [
                                    { header: 1 },
                                    { header: 2 },
                                    "blockquote",
                                    "code-block",
                                ],
                                [
                                    { list: "ordered" },
                                    { list: "bullet" },
                                    { indent: "-1" },
                                    { indent: "+1" },
                                ],
                                [{ direction: "rtl" }, { align: [] }],
                                ["link", "image", "video", "formula"],
                                ["clean"],
                            ],
                        },
                        placeholder: "à¸à¸´à¸¡à¸à¹Œà¸„à¸³à¹à¸›à¸¥à¸ à¸²à¸©à¸²à¹„à¸—à¸¢à¸—à¸µà¹ˆà¸™à¸µà¹ˆ...",
                    });

                    if (thai) {
                        quill.root.innerHTML = thai;
                    }
                }
            }, 100);
        }

        function closeModal() {
            var modal = document.getElementById("edit-modal");
            modal.classList.add("hidden");
            editingId = null;
            quill = null;
            document.getElementById("editor-container").innerHTML = "";
        }

        function saveTranslation() {
            if (!editingId) return;

            var saveBtn = document.getElementById("modal-save");
            saveBtn.disabled = true;
            saveBtn.textContent = "à¸à¸³à¸¥à¸±à¸‡à¸šà¸±à¸™à¸—à¸¶à¸...";

            var text_th = "";
            if (quill) {
                text_th = quill.root.innerHTML;
            }

            fetch(API_URL + "/api/admin/tafsir-assadi/" + editingId, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ text_th: text_th }),
            })
                .then(function (res) {
                    if (res.ok) {
                        closeModal();
                        fetchEntries();
                        fetchStats();
                    } else {
                        alert("à¸šà¸±à¸™à¸—à¸¶à¸à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ");
                    }
                })
                .catch(function (e) {
                    console.error("Failed to save:", e);
                    alert("à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”");
                })
                .finally(function () {
                    saveBtn.disabled = false;
                    saveBtn.textContent = "ğŸ’¾ à¸šà¸±à¸™à¸—à¸¶à¸";
                });
        }

        document.addEventListener("DOMContentLoaded", function () {
            initSurahSelect();
            fetchStats();
            fetchEntries();

            document
                .getElementById("prev-btn")
                .addEventListener("click", function () {
                    if (currentPage > 1) {
                        currentPage--;
                        fetchEntries();
                    }
                });

            document
                .getElementById("next-btn")
                .addEventListener("click", function () {
                    if (currentPage < totalPages) {
                        currentPage++;
                        fetchEntries();
                    }
                });

            document
                .getElementById("modal-close")
                .addEventListener("click", closeModal);
            document
                .getElementById("modal-cancel")
                .addEventListener("click", closeModal);
            document
                .getElementById("modal-save")
                .addEventListener("click", saveTranslation);

            document
                .getElementById("edit-modal")
                .addEventListener("click", function (e) {
                    if (e.target === e.currentTarget) closeModal();
                });
        });
    </script>
</AdminLayout>

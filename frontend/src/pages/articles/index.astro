---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getArticles, getCategories } from "../../lib/api";

const page = Number(Astro.url.searchParams.get("page") || 1);
const category = Astro.url.searchParams.get("category") || "";

let articlesData = { data: [], total: 0, total_pages: 1 };
let categories: any[] = [];
let categoryName = "";

try {
    const [articlesRes, categoriesRes] = await Promise.all([
        getArticles({ page, category, status: "published", limit: 9 }),
        getCategories(),
    ]);
    articlesData = articlesRes;
    categories = categoriesRes.categories || [];

    if (category) {
        const cat = categories.find((c: any) => c.slug === category);
        if (cat) categoryName = cat.name;
    }
} catch (e) {
    console.error("Failed to fetch articles:", e);
}

const formatDate = (dateStr: string) => {
    try {
        return new Date(dateStr).toLocaleDateString("th-TH", {
            year: "numeric",
            month: "long",
            day: "numeric",
        });
    } catch {
        return "";
    }
};

// Pastel colors for cards (matching homepage)
const cardColors = [
    "from-mint-soft to-white border-mint-light",
    "from-pink-soft to-white border-pink-light",
    "from-primary-soft to-white border-primary-light",
    "from-peach-soft to-white border-peach-light",
    "from-sky-soft to-white border-sky-light",
    "from-lavender-light to-white border-lavender",
];
---

<BaseLayout
    title={categoryName ? `‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°: ${categoryName}` : "‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏™‡∏≤‡∏£‡∏∞‡∏ô‡πà‡∏≤‡∏£‡∏π‡πâ"}
    description="‡∏£‡∏ß‡∏°‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏¥‡∏™‡∏•‡∏≤‡∏° ‡∏´‡∏∞‡∏î‡∏µ‡∏© ‡πÅ‡∏•‡∏∞‡∏™‡∏≤‡∏£‡∏∞‡∏ô‡πà‡∏≤‡∏£‡∏π‡πâ‡∏à‡∏≤‡∏Å‡∏ã‡∏∏‡∏ô‡∏ô‡∏∞‡∏´‡πå‡πÑ‡∏ó‡∏¢"
>
    <!-- Hero Section - Matching Homepage Style -->
    <section class="relative overflow-hidden py-16 md:py-20">
        <!-- Decorative blobs -->
        <div class="absolute top-20 right-10 w-72 h-72 bg-pink-light/40 blob blur-3xl"></div>
        <div class="absolute top-40 left-10 w-64 h-64 bg-primary-light/30 blob blur-3xl"></div>
        <div class="absolute bottom-10 right-1/4 w-48 h-48 bg-mint-light/40 blob blur-3xl"></div>

        <div class="container mx-auto px-4 relative z-10">
            <div class="text-center max-w-3xl mx-auto animate-fade-in">
                <h1 class="text-4xl md:text-5xl lg:text-6xl font-bold text-text mb-4">
                    {categoryName ? (
                        <>üìÇ ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà: <span class="text-gradient">{categoryName}</span></>
                    ) : (
                        <>üå∏ <span class="text-gradient">‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°</span>‡πÅ‡∏•‡∏∞‡∏™‡∏≤‡∏£‡∏∞‡∏ô‡πà‡∏≤‡∏£‡∏π‡πâ</>
                    )}
                </h1>
                <p class="text-lg text-text-muted mb-8 max-w-xl mx-auto">
                    ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏≠‡∏¥‡∏™‡∏•‡∏≤‡∏° ‡∏Å‡∏≤‡∏£‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏´‡∏∞‡∏î‡∏µ‡∏© ‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡∏£‡πá‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏ï‡πà‡∏≤‡∏á‡πÜ
                </p>
            </div>
        </div>
    </section>

    <div class="container mx-auto px-4 -mt-4 relative z-10 pb-16">
        <!-- Category Filter - Pill Style -->
        <div class="flex flex-wrap gap-3 justify-center mb-12">
            <a
                href="/articles"
                class={`px-5 py-2.5 rounded-full text-sm font-semibold transition-all duration-300 ${
                    !category
                        ? "bg-gradient-to-r from-primary to-pink text-white shadow-lg hover:shadow-xl"
                        : "bg-white/80 text-text-muted hover:bg-white hover:text-primary border border-primary-light"
                }`}
            >
                üè† ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            </a>
            {categories.map((c: any) => (
                <a
                    href={`/articles?category=${c.slug}`}
                    class={`px-5 py-2.5 rounded-full text-sm font-semibold transition-all duration-300 ${
                        category === c.slug
                            ? "bg-gradient-to-r from-primary to-pink text-white shadow-lg hover:shadow-xl"
                            : "bg-white/80 text-text-muted hover:bg-white hover:text-primary border border-primary-light"
                    }`}
                >
                    {c.name}
                </a>
            ))}
        </div>

        <!-- Articles Grid -->
        {articlesData.data.length === 0 ? (
            <div class="card bg-gradient-to-br from-mint-soft to-white border-2 border-mint-light text-center py-20 max-w-lg mx-auto">
                <div class="text-6xl mb-6">üìù</div>
                <h3 class="text-2xl font-bold text-text mb-3">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà</h3>
                <p class="text-text-muted">
                    ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏ä‡∏°‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏≠‡∏∑‡πà‡∏ô
                </p>
            </div>
        ) : (
            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8 max-w-6xl mx-auto">
                {articlesData.data.map((article: any, index: number) => {
                    const colorClass = cardColors[index % cardColors.length];
                    return (
                        <a
                            href={`/articles/${article.slug}`}
                            class={`group card bg-gradient-to-br ${colorClass} border-2 hover:shadow-glow hover:-translate-y-2 transition-all duration-300 overflow-hidden`}
                        >
                            <!-- Cover Image -->
                            <div class="aspect-video -mx-6 -mt-6 mb-4 overflow-hidden relative">
                                {article.cover_image ? (
                                    <img
                                        src={article.cover_image}
                                        alt={article.title}
                                        class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
                                        loading="lazy"
                                    />
                                ) : (
                                    <div class="w-full h-full bg-gradient-to-br from-primary-light to-pink-light flex items-center justify-center">
                                        <span class="text-5xl">üìñ</span>
                                    </div>
                                )}
                                
                                <!-- Category badge -->
                                <div class="absolute top-3 left-3">
                                    <span class="bg-white/90 backdrop-blur px-3 py-1 rounded-full text-xs font-bold text-primary shadow-sm">
                                        {categories.find((c: any) => c.slug === article.category)?.name || "‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ"}
                                    </span>
                                </div>
                            </div>

                            <!-- Content -->
                            <h3 class="font-bold text-xl text-text mb-2 group-hover:text-primary transition-colors line-clamp-2">
                                {article.title}
                            </h3>
                            
                            <p class="text-text-muted text-sm mb-4 line-clamp-3 leading-relaxed">
                                {article.content?.replace(/<[^>]*>/g, "").substring(0, 120)}...
                            </p>
                            
                            <div class="flex items-center justify-between pt-4 border-t border-white/50">
                                <span class="text-xs text-text-light flex items-center gap-1">
                                    üìÖ {formatDate(article.created_at)}
                                </span>
                                <span class="text-primary font-semibold text-sm flex items-center gap-1 group-hover:gap-2 transition-all">
                                    ‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
                                    <span>‚Üí</span>
                                </span>
                            </div>
                        </a>
                    );
                })}
            </div>
        )}

        <!-- Pagination -->
        {articlesData.total_pages > 1 && (
            <div class="flex justify-center mt-12 gap-2">
                {page > 1 && (
                    <a
                        href={`?page=${page - 1}${category ? `&category=${category}` : ''}`}
                        class="w-12 h-12 flex items-center justify-center rounded-xl bg-white/80 border-2 border-primary-light text-text-muted hover:bg-white hover:text-primary transition-all"
                    >
                        ‚Üê
                    </a>
                )}
                
                {Array.from({ length: articlesData.total_pages }, (_, i) => i + 1).map((p) => (
                    <a
                        href={`?page=${p}${category ? `&category=${category}` : ''}`}
                        class={`w-12 h-12 flex items-center justify-center rounded-xl font-semibold transition-all ${
                            p === page
                                ? "bg-gradient-to-r from-primary to-pink text-white shadow-lg"
                                : "bg-white/80 text-text-muted border-2 border-primary-light hover:bg-white hover:text-primary"
                        }`}
                    >
                        {p}
                    </a>
                ))}
                
                {page < articlesData.total_pages && (
                    <a
                        href={`?page=${page + 1}${category ? `&category=${category}` : ''}`}
                        class="w-12 h-12 flex items-center justify-center rounded-xl bg-white/80 border-2 border-primary-light text-text-muted hover:bg-white hover:text-primary transition-all"
                    >
                        ‚Üí
                    </a>
                )}
            </div>
        )}
    </div>
</BaseLayout>

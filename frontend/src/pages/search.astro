---
import BaseLayout from "../layouts/BaseLayout.astro";
import {
    getHadiths,
    getDynamicBookNames,
    BOOK_NAMES,
    type HadithsResponse,
} from "../lib/api";

const MAIN_BOOKS = [
    "bukhari",
    "muslim",
    "nasai",
    "tirmidhi",
    "abudawud",
    "ibnmajah",
];

// Get dynamic book names
let bookNames = { ...BOOK_NAMES };
try {
    const dynamicNames = await getDynamicBookNames();
    bookNames = { ...bookNames, ...dynamicNames };
} catch (error) {
    console.error("Failed to fetch dynamic book names:", error);
}

// Get search query from URL
const url = new URL(Astro.request.url);
const query = url.searchParams.get("q") || "";
const book = url.searchParams.get("book") || "";
const page = parseInt(url.searchParams.get("page") || "1");

// Search all books if query exists
let searchResults: HadithsResponse | null = null;

if (query.trim()) {
    try {
        searchResults = await getHadiths({
            search: query,
            page,
            limit: 20,
            book: book || undefined,
        });
    } catch (error) {
        console.error("Search error:", error);
    }
}

// Highlight function
function highlightText(text: string, searchQuery: string): string {
    if (!text || !searchQuery.trim()) return text;
    const regex = new RegExp(
        `(${searchQuery.replace(/[.*+?^${}()|[\]\\]/g, "\\$&")})`,
        "gi",
    );
    return text.replace(
        regex,
        '<mark class="bg-yellow-200 text-yellow-900 px-0.5 rounded">$1</mark>',
    );
}

// Helper to get grade badge color
function getGradeColor(status: string): string {
    if (!status) return "bg-gray-100 text-gray-800 border-gray-200";
    if (status.includes("Sahih") || status.includes("‡∏ã‡∏≠‡πÄ‡∏Æ‡∏µ‡∏¢‡∏∞‡∏Æ‡πå"))
        return "bg-emerald-100 text-emerald-800 border bg-emerald-100/50 border-emerald-200";
    if (status.includes("Hasan") || status.includes("‡∏´‡∏∞‡∏™‡∏±‡∏ô"))
        return "bg-sky-100 text-sky-800 border bg-sky-100/50 border-sky-200";
    if (
        status.includes("Daif") ||
        status.includes("Da'if") ||
        status.includes("‡∏é‡∏≠‡∏≠‡∏µ‡∏ü")
    )
        return "bg-orange-100 text-orange-800 border bg-orange-100/50 border-orange-200";
    if (status.includes("Mawdu") || status.includes("‡πÄ‡∏°‡∏≤‡∏é‡∏±‡πä‡∏ß‡∏∞"))
        return "bg-red-100 text-red-800 border bg-red-100/50 border-red-200";
    return "bg-gray-100 text-gray-800 border bg-gray-100/50 border-gray-200";
}
---

<BaseLayout title={`‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ "${query}" | ‡∏ã‡∏∏‡∏ô‡∏ô‡∏∞‡∏´‡πå‡πÑ‡∏ó‡∏¢`}>
    <section class="container mx-auto px-4 py-8">
        <!-- Search Header -->
        <div class="max-w-2xl mx-auto mb-8">
            <h1 class="text-2xl font-bold text-text mb-4">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏∞‡∏î‡∏µ‡∏©</h1>

            <form method="get" class="flex gap-3">
                <input
                    type="text"
                    name="q"
                    value={query}
                    placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..."
                    class="input flex-1"
                    autofocus
                />
                <select name="book" class="select w-1/3 md:w-auto">
                    <option value="">‡∏ó‡∏∏‡∏Å‡πÄ‡∏•‡πà‡∏° üìö</option>
                    {
                        MAIN_BOOKS.map((key) => (
                            <option value={key} selected={book === key}>
                                {bookNames[key]?.th || BOOK_NAMES[key]?.th}
                            </option>
                        ))
                    }
                </select>
                <button type="submit" class="btn btn-primary">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
            </form>
        </div>

        <!-- Results -->
        {
            query.trim() ? (
                searchResults && searchResults.data.length > 0 ? (
                    <div class="max-w-4xl mx-auto">
                        <p class="text-sm text-text-muted mb-6">
                            üå∏ ‡∏û‡∏ö {searchResults.total.toLocaleString()}{" "}
                            ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "
                            <span class="font-medium text-primary">
                                {query}
                            </span>
                            "
                        </p>

                        <div class="space-y-4">
                            {searchResults.data.map((hadith) => {
                                const bookInfo = bookNames[
                                    hadith.hadith_book
                                ] ||
                                    BOOK_NAMES[hadith.hadith_book] || {
                                        th: hadith.hadith_book,
                                        icon: "üìö",
                                    };
                                const contentText =
                                    hadith.content.th || hadith.content.ar;
                                const highlightedContent = highlightText(
                                    contentText,
                                    query,
                                );

                                return (
                                    <a
                                        href={`/${hadith.hadith_book}?search=${encodeURIComponent(query)}`}
                                        class="block card hover:border-primary"
                                    >
                                        <div class="flex items-start gap-3">
                                            <span class="text-2xl">
                                                {bookInfo.icon}
                                            </span>
                                            <div class="flex-1 min-w-0">
                                                <div class="flex items-center gap-2 mb-2">
                                                    <span class="text-xs font-medium text-white bg-gradient-to-r from-primary to-pink px-2 py-1 rounded-pill">
                                                        {bookInfo.th} #
                                                        {hadith.hadith_no ||
                                                            hadith.hadith_id}
                                                    </span>
                                                    {hadith.status ===
                                                        "translated" && (
                                                        <span class="badge badge-success text-xs">
                                                            ‚ú® ‡πÅ‡∏õ‡∏•‡πÅ‡∏•‡πâ‡∏ß
                                                        </span>
                                                    )}
                                                    {hadith.hadith_status && (
                                                        <span
                                                            class={`px-2 py-0.5 rounded-md text-xs font-medium border ${getGradeColor(hadith.hadith_status)}`}
                                                        >
                                                            ‚úÖ{" "}
                                                            {
                                                                hadith.hadith_status
                                                            }
                                                        </span>
                                                    )}
                                                </div>

                                                <p
                                                    class={`text-sm line-clamp-3 ${hadith.content.th ? "text-text" : "text-text-muted font-arabic"}`}
                                                    dir={
                                                        hadith.content.th
                                                            ? "ltr"
                                                            : "rtl"
                                                    }
                                                    set:html={
                                                        highlightedContent
                                                    }
                                                />
                                            </div>
                                        </div>
                                    </a>
                                );
                            })}
                        </div>

                        {/* Pagination */}
                        {searchResults.total_pages > 1 && (
                            <nav class="flex justify-center items-center gap-2 mt-8">
                                {page > 1 && (
                                    <a
                                        href={`/search?q=${encodeURIComponent(query)}&book=${book}&page=${page - 1}`}
                                        class="btn btn-secondary"
                                    >
                                        ‚Üê ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
                                    </a>
                                )}
                                <span class="px-4 py-2 text-text-muted">
                                    ‡∏´‡∏ô‡πâ‡∏≤ {page} / {searchResults.total_pages}
                                </span>
                                {page < searchResults.total_pages && (
                                    <a
                                        href={`/search?q=${encodeURIComponent(query)}&book=${book}&page=${page + 1}`}
                                        class="btn btn-primary"
                                    >
                                        ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Üí
                                    </a>
                                )}
                            </nav>
                        )}
                    </div>
                ) : (
                    <div class="text-center py-16">
                        <div class="text-6xl mb-4">üîç</div>
                        <h2 class="text-xl font-bold text-text mb-2">
                            ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
                        </h2>
                        <p class="text-text-muted">
                            ‡∏•‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏≥‡∏≠‡∏∑‡πà‡∏ô ‡πÄ‡∏ä‡πà‡∏ô ‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏´‡∏∞‡∏î‡∏µ‡∏©
                        </p>
                    </div>
                )
            ) : (
                <div class="text-center py-16">
                    <div class="text-6xl mb-4">‚ú®</div>
                    <h2 class="text-xl font-bold text-text mb-2">
                        ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏∞‡∏î‡∏µ‡∏©‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
                    </h2>
                    <p class="text-text-muted">
                        ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô ‡πÄ‡∏ä‡πà‡∏ô "‡∏•‡∏∞‡∏´‡∏°‡∏≤‡∏î" ‡∏´‡∏£‡∏∑‡∏≠ "ÿ≤ŸÉÿßÿ©"
                    </p>
                </div>
            )
        }
    </section>
</BaseLayout>

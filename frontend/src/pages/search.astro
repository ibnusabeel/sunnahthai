---
import BaseLayout from "../layouts/BaseLayout.astro";
import {
    getHadiths,
    getDynamicBookNames,
    BOOK_NAMES,
    type HadithsResponse,
} from "../lib/api";

const MAIN_BOOKS = [
    "bukhari",
    "muslim",
    "nasai",
    "tirmidhi",
    "abudawud",
    "ibnmajah",
];

// Get dynamic book names
let bookNames = { ...BOOK_NAMES };
try {
    const dynamicNames = await getDynamicBookNames();
    bookNames = { ...bookNames, ...dynamicNames };
} catch (error) {
    console.error("Failed to fetch dynamic book names:", error);
}

// Get search query from URL
const url = new URL(Astro.request.url);
const query = url.searchParams.get("q") || "";
const book = url.searchParams.get("book") || "";
const page = parseInt(url.searchParams.get("page") || "1");

// Search all books if query exists
let searchResults: HadithsResponse | null = null;

if (query.trim()) {
    try {
        searchResults = await getHadiths({
            search: query,
            page,
            limit: 20,
            book: book || undefined,
        });
    } catch (error) {
        console.error("Search error:", error);
    }
}

// Highlight function
function highlightText(text: string, searchQuery: string): string {
    if (!text || !searchQuery.trim()) return text;
    const regex = new RegExp(
        `(${searchQuery.replace(/[.*+?^${}()|[\]\\]/g, "\\$&")})`,
        "gi",
    );
    return text.replace(
        regex,
        '<mark class="bg-yellow-200 text-yellow-900 px-0.5 rounded">$1</mark>',
    );
}

// Helper to get grade badge color
function getGradeColor(status: string): string {
    if (!status) return "bg-gray-100 text-gray-800 border-gray-200";
    if (status.includes("Sahih") || status.includes("‡∏ã‡∏≠‡πÄ‡∏Æ‡∏µ‡∏¢‡∏∞‡∏Æ‡πå"))
        return "bg-emerald-100 text-emerald-800 border bg-emerald-100/50 border-emerald-200";
    if (status.includes("Hasan") || status.includes("‡∏´‡∏∞‡∏™‡∏±‡∏ô"))
        return "bg-sky-100 text-sky-800 border bg-sky-100/50 border-sky-200";
    if (
        status.includes("Daif") ||
        status.includes("Da'if") ||
        status.includes("‡∏é‡∏≠‡∏≠‡∏µ‡∏ü")
    )
        return "bg-orange-100 text-orange-800 border bg-orange-100/50 border-orange-200";
    if (status.includes("Mawdu") || status.includes("‡πÄ‡∏°‡∏≤‡∏é‡∏±‡πä‡∏ß‡∏∞"))
        return "bg-red-100 text-red-800 border bg-red-100/50 border-red-200";
    return "bg-gray-100 text-gray-800 border bg-gray-100/50 border-gray-200";
}
---

	<BaseLayout title={`‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ "${query}" | ‡∏ã‡∏∏‡∏ô‡∏ô‡∏∞‡∏´‡πå‡πÑ‡∏ó‡∏¢`}>
		<div class="min-h-screen bg-surface-muted/30">
			<!-- Header & Search Section -->
			<section class="relative pt-8 pb-12 overflow-hidden">
				<!-- Background Blobs -->
				<div class="absolute top-0 right-0 w-64 h-64 bg-primary-light/20 blur-3xl -z-10 rounded-full"></div>
				<div class="absolute top-10 left-10 w-48 h-48 bg-pink-light/20 blur-3xl -z-10 rounded-full"></div>

				<div class="container mx-auto px-4 relative z-10">
					<div class="max-w-3xl mx-auto text-center mb-8">
						<h1 class="text-3xl md:text-4xl font-bold text-text mb-2">
							üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏∞‡∏î‡∏µ‡∏©
						</h1>
						<p class="text-text-muted">
							‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ ‡πÄ‡∏•‡∏Ç‡∏´‡∏∞‡∏î‡∏µ‡∏© ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠
						</p>
					</div>

					<div class="max-w-3xl mx-auto sticky top-4 z-50">
						<form method="get" class="relative group">
							<div class="absolute inset-0 bg-gradient-to-r from-primary-light to-pink-light rounded-2xl blur opacity-25 group-hover:opacity-40 transition-opacity"></div>
							<div class="relative flex items-center bg-white/90 backdrop-blur-xl rounded-2xl shadow-soft p-2 border border-white/50">
								<span class="pl-4 text-2xl">üîé</span>
								<input
									type="text"
									name="q"
									value={query}
									placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤... (‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏≤‡∏£‡∏•‡∏∞‡∏´‡∏°‡∏≤‡∏î, ‡∏ã‡∏∞‡∏Å‡∏≤‡∏ï)"
									class="w-full bg-transparent border-none focus:ring-0 text-lg placeholder:text-text-light px-4 text-text"
									autofocus
									autocomplete="off"
								/>
								<button 
									type="submit" 
									class="bg-gradient-to-r from-primary to-primary-dark text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:shadow-primary/30 hover:scale-105 active:scale-95 transition-all"
								>
									‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
								</button>
							</div>
						</form>
					</div>

					<!-- Book Filters (Scrollable Chips) -->
					<div class="max-w-4xl mx-auto mt-8 overflow-x-auto pb-4 scrollbar-hide">
						<div class="flex gap-3 px-2 min-w-max">
							<a 
								href={`/search?q=${encodeURIComponent(query)}`}
								class={`flex items-center gap-2 px-5 py-2.5 rounded-full transition-all duration-300 border ${
									!book 
										? "bg-primary text-white border-primary shadow-lg shadow-primary/20 scale-105" 
										: "bg-white text-text-muted border-slate-200 hover:border-primary-light hover:bg-primary-soft/30"
								}`}
							>
								<span>üìö</span>
								<span class="font-medium">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
							</a>
							{
								MAIN_BOOKS.map((key) => {
									const bookInfo = bookNames[key] || BOOK_NAMES[key];
									const isActive = book === key;
									return (
										<a
											href={`/search?q=${encodeURIComponent(query)}&book=${key}`}
											class={`flex items-center gap-2 px-5 py-2.5 rounded-full transition-all duration-300 border ${
												isActive
													? "bg-primary text-white border-primary shadow-lg shadow-primary/20 scale-105"
													: "bg-white text-text-muted border-slate-200 hover:border-primary-light hover:bg-primary-soft/30"
											}`}
										>
											<span>{bookInfo?.icon || "üìñ"}</span>
											<span class="font-medium">{bookInfo?.th || key}</span>
										</a>
									);
								})
							}
						</div>
					</div>
				</div>
			</section>

			<!-- Results Section -->
			<section class="container mx-auto px-4 pb-20">
				{
					query.trim() ? (
						searchResults && searchResults.data.length > 0 ? (
							<div class="max-w-4xl mx-auto">
								<div class="flex items-center justify-between mb-6 px-2">
									<p class="text-text-muted">
										‡∏û‡∏ö <span class="font-bold text-primary text-lg">{searchResults.total.toLocaleString()}</span> ‡∏´‡∏∞‡∏î‡∏µ‡∏©
									</p>
									<div class="text-xs text-text-light">
										‡∏´‡∏ô‡πâ‡∏≤ {page} ‡∏à‡∏≤‡∏Å {searchResults.total_pages}
									</div>
								</div>

								<div class="grid gap-6">
									{searchResults.data.map((hadith) => {
										const bookInfo = bookNames[hadith.hadith_book] || BOOK_NAMES[hadith.hadith_book] || {
											th: hadith.hadith_book,
											icon: "üìö",
										};
										const contentText = hadith.content.th || hadith.content.ar;
										const highlightedContent = highlightText(contentText, query);

										return (
											<a
												href={`/${hadith.hadith_book}?search=${encodeURIComponent(query)}#hadith-${hadith.hadith_no}`}
												class="group block bg-white rounded-3xl p-6 border border-slate-100 hover:border-primary-light/50 shadow-sm hover:shadow-soft transition-all duration-300 relative overflow-hidden"
											>
												<div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-primary-soft/20 to-transparent rounded-bl-full -mr-10 -mt-10 transition-transform group-hover:scale-110"></div>
												
												<div class="relative z-10">
													<!-- Header Badges -->
													<div class="flex flex-wrap items-center gap-2 mb-4">
														<div class="flex items-center gap-1.5 pl-1 pr-3 py-1 rounded-full bg-slate-50 border border-slate-100">
															<span class="text-lg">{bookInfo.icon}</span>
															<span class="font-bold text-sm text-text-muted">{bookInfo.th}</span>
														</div>
														<div class="px-3 py-1 rounded-full bg-primary-soft/50 text-primary-dark font-mono font-bold text-sm border border-primary-light/30">
															#{hadith.hadith_no || hadith.hadith_id}
														</div>
														{hadith.hadith_status && (
															<span class={`px-3 py-1 rounded-full text-xs font-bold border ${getGradeColor(hadith.hadith_status)}`}>
																{hadith.hadith_status}
															</span>
														)}
													</div>

													<!-- Content -->
													<div class="space-y-4">
														{/* Thai Text */}
														<div class="font-thai text-lg leading-relaxed text-text">
															<p 
																set:html={highlightedContent}
																class={hadith.content.th ? "" : "text-text-muted italic"} 
															/>
														</div>

														{/* Arabic Text Preview (Truncated) */}
														<div class="relative pr-4 py-2 border-r-4 border-primary-light/30 bg-primary-soft/10 rounded-l-xl">
															<p class="font-arabic text-xl text-text-muted leading-loose text-right line-clamp-2" dir="rtl">
																{hadith.content.ar}
															</p>
														</div>
													</div>

													<div class="mt-4 flex items-center justify-end gap-2 text-primary font-medium text-sm opacity-0 group-hover:opacity-100 transition-opacity transform translate-y-2 group-hover:translate-y-0">
														‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° <span class="text-lg">‚Üí</span>
													</div>
												</div>
											</a>
										);
									})}
								</div>

								{/* Pagination */}
								{searchResults.total_pages > 1 && (
									<div class="flex justify-center items-center gap-3 mt-12 bg-white/50 backdrop-blur rounded-2xl p-4 w-fit mx-auto border border-white/60 shadow-sm">
										{page > 1 ? (
											<a
												href={`/search?q=${encodeURIComponent(query)}&book=${book}&page=${page - 1}`}
												class="w-10 h-10 flex items-center justify-center rounded-xl bg-white border border-slate-200 text-text hover:bg-primary-soft hover:text-primary transition-colors"
											>
												‚Üê
											</a>
										) : (
											<span class="w-10 h-10 flex items-center justify-center rounded-xl bg-slate-100 text-slate-300 cursor-not-allowed">‚Üê</span>
										)}
										
										<span class="font-bold text-primary">
											{page}
										</span>
										<span class="text-text-muted">/</span>
										<span class="text-text-muted">
											{searchResults.total_pages}
										</span>

										{page < searchResults.total_pages ? (
											<a
												href={`/search?q=${encodeURIComponent(query)}&book=${book}&page=${page + 1}`}
												class="w-10 h-10 flex items-center justify-center rounded-xl bg-primary text-white shadow-lg shadow-primary/30 hover:bg-primary-dark transition-colors"
											>
												‚Üí
											</a>
										) : (
											<span class="w-10 h-10 flex items-center justify-center rounded-xl bg-slate-100 text-slate-300 cursor-not-allowed">‚Üí</span>
										)}
									</div>
								)}
							</div>
						) : (
							<div class="text-center py-20 animate-fade-in">
								<div class="w-32 h-32 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-6 text-6xl grayscale opacity-50">
									ü§∑‚Äç‚ôÇÔ∏è
								</div>
								<h2 class="text-2xl font-bold text-text mb-2">
									‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "{query}"
								</h2>
								<p class="text-text-muted max-w-md mx-auto">
									‡∏•‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ï‡∏±‡∏ß‡∏™‡∏∞‡∏Å‡∏î ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô <br/> 
									‡πÄ‡∏ä‡πà‡∏ô "‡∏•‡∏∞‡∏´‡∏°‡∏≤‡∏î" ‡πÅ‡∏ó‡∏ô "‡∏Å‡∏≤‡∏£‡∏•‡∏∞‡∏´‡∏°‡∏≤‡∏î‡∏ß‡∏±‡∏ô‡∏®‡∏∏‡∏Å‡∏£‡πå"
								</p>
								<div class="mt-8">
									<a href="/search" class="text-primary hover:underline">‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</a>
								</div>
							</div>
						)
					) : (
						<div class="max-w-4xl mx-auto py-12">
							<div class="grid md:grid-cols-2 gap-8 items-center">
								<div class="text-center md:text-left space-y-4">
									<h2 class="text-2xl font-bold text-text">
										üè∑Ô∏è ‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°
									</h2>
									<div class="flex flex-wrap gap-2 justify-center md:justify-start">
										{["‡∏•‡∏∞‡∏´‡∏°‡∏≤‡∏î", "‡∏ñ‡∏∑‡∏≠‡∏®‡∏µ‡∏•‡∏≠‡∏î", "‡∏ã‡∏∞‡∏Å‡∏≤‡∏ï/‡∏ó‡∏≤‡∏ô", "‡∏Æ‡∏±‡∏à‡∏ç‡πå", "‡∏°‡∏≤‡∏£‡∏¢‡∏≤‡∏ó", "‡∏î‡∏∏‡∏≠‡∏≤‡∏≠‡πå", "‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå", "‡∏ô‡∏£‡∏Å"].map(tag => (
											<a 
												href={`/search?q=${tag}`}
												class="px-4 py-2 rounded-xl bg-white border border-slate-100 hover:border-primary-light hover:bg-primary-soft hover:text-primary transition-all shadow-sm"
											>
												# {tag}
											</a>
										))}
									</div>
								</div>
								<div class="hidden md:block text-center p-8 bg-gradient-to-br from-primary-soft/30 to-pink-soft/30 rounded-3xl border border-white/50">
									<span class="text-6xl filter drop-shadow-lg">üïå</span>
									<p class="mt-4 font-medium text-primary-dark">
										"‡∏ú‡∏π‡πâ‡πÉ‡∏î‡∏ä‡∏µ‡πâ‡πÅ‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ ‡πÄ‡∏Ç‡∏≤‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏•‡∏ö‡∏∏‡∏ç<br/>‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ‡∏ô‡∏±‡πâ‡∏ô" (‡∏°‡∏∏‡∏™‡∏•‡∏¥‡∏°)
									</p>
								</div>
							</div>
						</div>
					)
				}
			</section>
		</div>
	</BaseLayout>
